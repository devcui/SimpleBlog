<!doctype html><html lang=cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Micrometer Concepts | 神奇宝贝大师的旅行日记</title><meta name=keywords content="prometheus"><meta name=description content="Desc Text."><meta name=author content="cui"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="blog"><meta name=yandex-verification content="blog"><meta name=msvalidate.01 content="blog"><link crossorigin=anonymous href=/pokemon/assets/css/stylesheet.2068759a50238aee83375bc8cb602a1caff7316bea9cc81b83d90aeea0e276c5.css integrity="sha256-IGh1mlAjiu6DN1vIy2AqHK/3MWvqnMgbg9kK7qDidsU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/pokemon/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://devcui.github.io/pokemon/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://devcui.github.io/pokemon/images/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://devcui.github.io/pokemon/images/favicon.png><link rel=apple-touch-icon href=https://devcui.github.io/pokemon/images/favicon.png><link rel=mask-icon href=https://devcui.github.io/pokemon/images/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-213464061-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Micrometer Concepts"><meta property="og:description" content="Desc Text."><meta property="og:type" content="article"><meta property="og:url" content="https://devcui.github.io/pokemon/posts/prometheus/micrometer-concepts/"><meta property="og:image" content="https://devcui.github.io/pokemon/images/head.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-05T11:30:03+00:00"><meta property="article:modified_time" content="2021-12-05T11:30:03+00:00"><meta property="og:site_name" content="神奇宝贝大师的旅行日记"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devcui.github.io/pokemon/images/head.png"><meta name=twitter:title content="Micrometer Concepts"><meta name=twitter:description content="Desc Text."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://devcui.github.io/pokemon/posts/"},{"@type":"ListItem","position":2,"name":"Micrometer Concepts","item":"https://devcui.github.io/pokemon/posts/prometheus/micrometer-concepts/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Micrometer Concepts","name":"Micrometer Concepts","description":"Desc Text.","keywords":["prometheus"],"articleBody":"1.什么是 Micrometer 针对JVM Application的指标库工具 SPI 服务商应用接口 2.支持的服务商 AppOptics Atlas Azure Monitor Cloudwatch Datadog Datadog StatsD Dynatrace Elastic Humio Influx KairosDB New Relic Prometheus SignalFx Sysdig StatsD Telegraf StatsD Wavefront 3.注册 Registry Meter是测量你的应用程序指标的一个集合 Meter在Micrometer中被MeterRegistry创建并保存 每个受支持的监控服务商都有一套对应的MeterRegistry实现 SimpleMeterRegistry可以将数据保存在内存中,不会将数据导出到任何地方 假如没有首选监控系统，可以从SimpleMeterRegistry开始 MeterRegistry registry = new SimpleMeterRegistry(); SimpleMeterRegistry可以在Springboot中直接注入 3.1 Composite registries 提供了CompositeMeterRegistry，可以添加多个注册表 通过CompositeMeterRegistry可以将指标推送到多个监控系统 1 2 3 4 5 6 7 8 9 10 11 12 // 声明一个复合注册表 CompositeMeterRegistry composite = new CompositeMeterRegistry(); // 从复合注册表声明一个名为counter的计数器 Counter compositeCounter = composite.counter(\"counter\"); // 计数器增1 compositeCounter.increment(); // 简单注册表 SimpleMeterRegistry simple = new SimpleMeterRegistry(); // 将简单注册表加入复合注册表中 composite.add(simple); (2) // 简单注册表和复合注册表的计数器都会累加1 compositeCounter.increment(); 3.2 Global registry 提供一个全局静态的注册表以及一组用于基于此注册表生成仪表的静态生成器\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 class MyComponent { Counter featureCounter = Metrics.counter(\"feature\", \"region\", \"test\"); void feature() { featureCounter.increment(); } void feature2(String type) { Metrics.counter(\"feature.2\", \"type\", type).increment(); } } class MyApplication { void start() { // wire your monitoring system to global static state Metrics.addRegistry(new SimpleMeterRegistry()); } } 4.Meters Micrometer 提供了仪表集合 Timer Counter Gauge DistributionSummary LongTaskTimer FunctionCounter FUnctionTimer TimeGauge 不同的仪表类型导致不同数量的时间序列指标 5.Naming meters 用 . 分割最小单词 比如在代码中`registry.timer(“http.server.requests”) 传入prometheus就会变为http_server_requests_duration_seconds 5.1 Tag naming 1 2 registry.counter(\"database.calls\", \"db\", \"users\") registry.counter(\"http.requests\", \"uri\", \"/api/users\") 可以从tag推测出测量的指标数据表示的内容为推荐命名方法\n5.2 Common tags 可以在注册表级别定义公共标签 registry.config().commonTags(“stack”,“prod”,“region”,“us-east-l”) registry.config().commonTags(Arrays.asList(Tag.of(“stack”, “prod”), Tag.of(“region”, “us-east-1”))) 如果在Spring环境中，请通过添加MeterRegistryCustomizer bean添加通用标签，以确保在自动配置仪表绑定程序之前应用了通用标签。 5.3 Tag values value必须非空 6. Meter filters 过滤功能 Deny Transform Configure 6.1 Deny/accept meters 1 2 3 4 5 6 7 8 9 new MeterFilter(){ @Override public MeterFilterReply accept(Meter.Id id){ if(id.getName().contains(\"test\")){ return MeterFilterReply.DENY; } return MeterFilterReply.NEUTRAL; } } MeterFilterReply.DENY 请勿注册该仪表 MeterFilterReply.NEUTRAL 如果没有其他仪表过滤器返回DENY，则仪表的注册将照常进行 MeterFIlterReply.ACCEPT 如果过滤器返回“接受”，仪表将立即注册，而不会询问任何其他过滤器的接受方法 6.11 Convenience methods MeterFIlter 为拒绝/接受类型过滤器提供了几个方便的静态生成器\naccept() accept(Predicate) acceptNameStartsWith(String) deny() deny(Predicate) denyNameStartsWith(String) maximumAllowableMetrics(int) 达到一定数量后拒绝 maximumAllowableTags(String meterNamePrefix,String tagKey,int maximumTagValues,MeterFilter) 匹配tag denyUnless(Predicate) 6.12 Chaining deny/accept meters 如下，该注册表中仅存名称包含http的指标\n1 2 3 registry.config() .meterFilter(MeterFilter.acceptNameStartsWith(\"http\")) .meterFilter(MeterFilter.deny()); 6.2 Transforming metrics 该过滤器有条件地向仪表添加以名称“ test”开头的名称前缀和附加标签。\n1 2 3 4 5 6 7 8 9 new MeterFilter() { @Override public Meter.Id map(Meter.Id id) { if(id.getName().startsWith(\"test\")) { return id.withName(\"extra.\" + id.getName()).withTag(\"extra.tag\", \"value\"); } return id; } } commonTags(Iterable) ignoreTags(String…) replaceTagValues(String tagKey,Functionreplcaement,String…exceptions) renameTag(String meterNamePrefix,String fromTagKey,String toTagKey) 6.3 Configuring distribution statistics 除了可以通过过滤器配置的计数，总计和最大值的基本知识外，Timer和DistributionSummary还包含一组可选的分配统计信息。 这些分布统计信息包括预先计算的百分位数，SLA和直方图。 通常，您应该仅使用要配置的部分创建一个新的DistributionStatisticConfig，然后将其与输入配置合并。 这使您可以下拉到注册表提供的分发统计信息的默认值，并将多个过滤器链接在一起，每个过滤器都配置了分发统计信息的某些部分 1 2 3 4 5 6 7 8 9 10 11 12 new MeterFilter() { @Override public DistributionStatisticConfig configure(Meter.Id id, DistributionStatisticConfig config) { if (id.getName().startsWith(prefix)) { return DistributionStatisticConfig.builder() .publishPercentiles(0.9, 0.95) .build() .merge(config); } return config; } }; maxExpected(Duration/long) minExpected(Duration/long) 7. Rate aggregation pass\n8. Counters 计数器报告一个指标，一个计数。计数器界面允许您以固定数量递增，该数量必须为正。\n1 2 3 4 5 6 Counter counter = Counter .builder(\"counter\") .baseUnit(\"beans\") // optional .description(\"a description of what this counter does\") // optional .tags(\"region\", \"test\") // optional .register(registry); 8.1 Function-tracking counters 1 2 3 4 5 6 7 8 MyCounterState state = ...; FunctionCounter counter = FunctionCounter .builder(\"counter\", state, state -\u003e state.count()) .baseUnit(\"beans\") // optional .description(\"a description of what this counter does\") // optional .tags(\"region\", \"test\") // optional .register(registry); 9. Guages 1 2 3 List\u003cString\u003e list = registry.gauge(\"listGauge\", Collections.emptyList(), new ArrayList\u003c\u003e(), List::size); List\u003cString\u003e list2 = registry.gaugeCollectionSize(\"listSize2\", Tags.empty(), new ArrayList\u003c\u003e()); Map\u003cString, Integer\u003e map = registry.gaugeMapSize(\"mapGauge\", Tags.empty(), new HashMap\u003c\u003e()); 9.1 Manually incrementing/decrementing a Guage 1 2 3 4 5 6 // maintain a reference to myGauge AtomicInteger myGauge = registry.gauge(\"numberGauge\", new AtomicInteger(0)); // ... elsewhere you can update the value it holds using the object reference myGauge.set(27); myGauge.set(11); 9.2 Gauge fluent builder 1 2 3 4 5 Gauge gauge = Gauge .builder(\"gauge\", myObj, myObj::gaugeValue) .description(\"a description of what this gauge does\") // optional .tags(\"region\", \"test\") // optional .register(registry); 9.3 Why is my guage reporting NaN or disapperaring pass\n9.4 Multi-gauge 1 2 3 4 5 6 7 8 9 10 11 12 13 // SELECT count(*) from job group by status WHERE job = 'dirty' MultiGauge statuses = MultiGauge.builder(\"statuses\") .tag(\"job\", \"dirty\") .description(\"The number of widgets in various statuses\") .baseUnit(\"widgets\") .register(registry); ... // run this periodically whenever you re-run your query statuses.register( resultSet.stream() .map(result -\u003e Row.of(Tags.of(\"status\", result.getAsString(\"status\")), result.getAsInt(\"count\")))); 10. Timmers 计时器用于测量短时延以及此类事件的频率。 Timer的所有实现至少将总时间和事件计数报告为单独的时间序列。 尽管可以将Timers用于其他用例，但请注意不支持负值，并且记录更长的持续时间可能会导致总时间溢出Long.MAX_VALUE纳秒（292.3年）。 1 2 3 4 5 Timer timer = Timer .builder(\"my.timer\") .description(\"a description of what this timer does\") // optional .tags(\"region\", \"test\") // optional .register(registry); 10.1 Recording blocks of code The Timer interface exposes several convenience overloads for recording timings inline 1 2 3 4 5 timer.record(() -\u003e dontCareAboutReturnValue()); timer.recordCallable(() -\u003e returnValue()); Runnable r = timer.wrap(() -\u003e dontCareAboutReturnValue()); (1) Callable c = timer.wrap(() -\u003e returnValue()); 10.2 Storing start state in Timer.Sample 您也可以将启动状态存储在一个示例实例中，以后可以将其停止。 该示例根据注册表的时钟记录开始时间。开始采样后，执行要计时的代码，并通过对采样调用stop（Timer）来完成操作。 1 2 3 4 5 6 Timer.Sample sample = Timer.start(registry); // do stuff Response response = ... sample.stop(registry.timer(\"my.timer\", \"response\", response.status())); 10.3 The @Timed annotation 核心模块包含@Timed批注，框架可使用该批注为特定类型的方法（例如为Web请求端点提供服务的方法）或通常为所有方法添加计时支持。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Service public class ExampleService { @Timed public void sync() { // @Timed will record the execution time of this method, // from the start and until it exits normally or exceptionally. ... } @Async @Timed public CompletableFuture\u003c?\u003e async() { // @Timed will record the execution time of this method, // from the start and until the returned CompletableFuture // completes normally or exceptionally. return CompletableFuture.supplyAsync(...); } } 10.4 Function-tracking timers 提供了一种更不常用的计时器模式，该模式可跟踪两个单调递增的函数 1 2 3 4 5 6 7 8 9 IMap\u003c?, ?\u003e cache = ... FunctionTimer.builder(\"cache.gets.latency\", cache, c -\u003e c.getLocalMapStats().getGetOperationCount(), c -\u003e c.getLocalMapStats().getTotalGetLatency(), TimeUnit.NANOSECONDS) .tags(\"name\", cache.getName()) .description(\"Cache gets\") .register(registry); 10.5 Pause detection 1 2 registry.config().pauseDetector(new ClockDriftPauseDetector(sleepInterval, pauseThreshold)); registry.config().pauseDetector(new NoPauseDetector()); 10.6 Memory footprint estimation pass\n11. Distribution summaries 1 2 3 4 5 6 7 DistributionSummary summary = DistributionSummary .builder(\"response.size\") .description(\"a description of what this summary does\") // optional .baseUnit(\"bytes\") // optional (1) .tags(\"region\", \"test\") // optional .scale(100) // optional (2) .register(registry); 11.1 Scaling and histograms 1 2 3 4 DistributionSummary.builder(\"my.ratio\") .scale(100) .sla(70, 80, 90) .register(registry) 11.2 Memory footprint estimation pass\n12. Long task timers 1 2 3 4 5 @Timed(value = \"aws.scrape\", longTask = true) @Scheduled(fixedDelay = 360000) void scrapeResources() { // find instances, volumes, auto-scaling groups, etc... } 1 2 3 4 5 6 LongTaskTimer scrapeTimer = registry.more().longTaskTimer(\"scrape\"); void scrapeResources() { scrapeTimer.record(() =\u003e { // find instances, volumes, auto-scaling groups, etc... }); } 1 2 3 4 5 LongTaskTimer longTaskTimer = LongTaskTimer .builder(\"long.task.timer\") .description(\"a description of what this timer does\") // optional .tags(\"region\", \"test\") // optional .register(registry); 13. Histograms and percentiles 1 2 3 4 5 6 Timer.builder(\"my.timer\") .publishPercentiles(0.5, 0.95) // median and 95th percentile .publishPercentileHistogram() .sla(Duration.ofMillis(100)) .minimumExpectedValue(Duration.ofMillis(1)) .maximumExpectedValue(Duration.ofSeconds(10)) 基本的概念和例子过了一遍，现在写一下DEMO 首先引入依赖\n1 2 3 4 5 6 7 8 9 10 io.micrometer micrometer-registry-prometheus 1.6.5 io.micrometer micrometer-core 1.6.5 然后搞一个配置类把指标加上commonTag\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.yunzainfo.cloud.staruniverse.config; import io.micrometer.core.instrument.MeterRegistry; import org.springframework.beans.factory.annotation.Value; import org.springframework.boot.actuate.autoconfigure.endpoint.web.WebEndpointProperties; import org.springframework.boot.actuate.autoconfigure.metrics.MeterRegistryCustomizer; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Primary; import java.util.HashSet; import java.util.Set; @Configuration public class MetricConfig { // 配置所有的指标前缀为 // contextPath 去掉斜杠 // 可以少配置一个applicationName @Bean MeterRegistryCustomizer\u003cMeterRegistry\u003e configurer(@Value(\"${server.servlet.context-path}\") String contextPath) { return registry -\u003e registry.config().commonTags(\"application\", contextPath.replaceAll(\"/\", \"\")); } // 这里主要是不想在改properties了，直接返回一个BEAN @Bean @Primary WebEndpointProperties asd() { WebEndpointProperties properties = new WebEndpointProperties(); Set\u003cString\u003e includes = new HashSet\u003c\u003e(); includes.add(\"*\"); properties.getExposure().setInclude(includes); return properties; } } 好了，现在说一下go和java的exporter的区别\n用go写的exporter是放出了一个url，Prometheus在时间间隔内访问我的exporter_url来scrape数据 用java就是 定时 查询指标，然后放在内存里，micrometer 集成了Springboot ，所以不用自定义url/接口来返回数据进行刮取，他会把内存中的数据通过url放出去给prometheus收集 实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 package com.yunzainfo.cloud.staruniverse.service.impl; import com.alibaba.fastjson.JSONObject; import com.yunzainfo.cloud.staruniverse.dto.PersonDto; import com.yunzainfo.cloud.staruniverse.service.MetricsTaskService; import io.micrometer.core.instrument.*; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.context.event.ApplicationReadyEvent; import org.springframework.context.event.EventListener; import org.springframework.stereotype.Service; import reactor.core.publisher.Flux; import java.time.Duration; import java.util.ArrayList; import java.util.HashSet; import java.util.List; import java.util.Set; import java.util.stream.Collectors; @Service public class MetricsTaskServiceImpl implements MetricsTaskService { @Autowired MeterRegistry meterRegistry; PersonDto personDto = new PersonDto(); MultiGauge g; @EventListener(ApplicationReadyEvent.class) public void mixMetrics() { this.registerMetrics(); Flux.interval(Duration.ofSeconds(5)).map(this::pushToHTTP).subscribe(); } public void registerMetrics() { Counter.builder(\"simulation.people.request\") .description(\"这是个计数器，只能加不能减\") .tag(\"sex\", \"男\") .tag(\"age\", \"30-50\") .register(this.meterRegistry); // 注册可变动值需要保留引用 personDto.setAge(Math.random()); Gauge.builder(\"simulation.people.ages\", personDto, personDto) .description(\"这是一个可以变动的数值\") .register(this.meterRegistry); // 多个可变动的值 g = MultiGauge.builder(\"simulation.people.statuses\") .tag(\"job\", \"dirty\") .description(\"The number of widgets in various statuses\") .baseUnit(\"widgets\") .register(this.meterRegistry); } public void setPeopleNumber() { // SELECT COUNT(*) FROM HTTP_REQUESTS WHERE SEX ='男' AND age \u003e= 30 AND age \u003c=50 meterRegistry.get(\"simulation.people.request\").counter().increment(1); } public void setPeopleAge() { personDto.setAge(Math.random()); } public void setStatus() { Set\u003cPersonDto\u003e hashSet = new HashSet\u003c\u003e(); PersonDto p1 = new PersonDto(); p1.setName(\"啊哈哈\"); p1.setAge(Math.random()); p1.setStatus(\"健康\"); PersonDto p2 = new PersonDto(); p2.setName(\"哇咔咔\"); p2.setAge(Math.random()); p2.setStatus(\"虚弱\"); PersonDto p3 = new PersonDto(); p3.setName(\"咦嘻嘻\"); p3.setAge(Math.random()); p3.setStatus(\"亚健康\"); hashSet.add(p1); hashSet.add(p2); hashSet.add(p3); g.register(hashSet.stream().map(result -\u003e MultiGauge.Row.of(Tags.of(\"status\", result.getStatus()), result.getAge())).collect(Collectors.toList()), true); } public int pushToHTTP(Long l) { setPeopleNumber(); setPeopleAge(); setStatus(); return 0; } } 效果\n结束，休息♨️!!!\n","wordCount":"1397","inLanguage":"cn","datePublished":"2021-12-05T11:30:03Z","dateModified":"2021-12-05T11:30:03Z","author":{"@type":"Person","name":"cui"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devcui.github.io/pokemon/posts/prometheus/micrometer-concepts/"},"publisher":{"@type":"Organization","name":"神奇宝贝大师的旅行日记","logo":{"@type":"ImageObject","url":"https://devcui.github.io/pokemon/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devcui.github.io/pokemon/ accesskey=h title="  (Alt + H)"><img src=https://devcui.github.io/pokemon/images/favicon.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://devcui.github.io/pokemon/posts title=列表><span>列表</span></a></li><li><a href=https://devcui.github.io/pokemon/categories title=分类><span>分类</span></a></li><li><a href=https://devcui.github.io/pokemon/tags title=标签><span>标签</span></a></li><li><a href=https://devcui.github.io/pokemon/series title=系列><span>系列</span></a></li><li><a href=https://devcui.github.io/pokemon/archives title=归档><span>归档</span></a></li><li><a href=https://devcui.github.io/pokemon/about title=关于><span>关于</span></a></li><li><a href=https://devcui.github.io/pokemon/sponsor title=赞助><span>赞助</span></a></li><li><a href=https://zukan.pokemon.co.jp/ title=图鉴><span>图鉴</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devcui.github.io/pokemon/>Home</a>&nbsp;»&nbsp;<a href=https://devcui.github.io/pokemon/posts/>Posts</a></div><h1 class=post-title>Micrometer Concepts</h1><div class=post-description>Desc Text.</div><div class=post-meta><span title='2021-12-05 11:30:03 +0000 UTC'>December 5, 2021</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;cui&nbsp;|&nbsp;<a href=https://github.com/devcui/pokemon/tree/master/content//posts/prometheus/micrometer-concepts.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1%e4%bb%80%e4%b9%88%e6%98%af-micrometer aria-label="1.什么是 Micrometer">1.什么是 Micrometer</a></li><li><a href=#2%e6%94%af%e6%8c%81%e7%9a%84%e6%9c%8d%e5%8a%a1%e5%95%86 aria-label=2.支持的服务商>2.支持的服务商</a></li><li><a href=#3%e6%b3%a8%e5%86%8c-registry aria-label="3.注册 Registry">3.注册 Registry</a><ul><li><a href=#31-composite-registries aria-label="3.1 Composite registries">3.1 Composite registries</a></li><li><a href=#32-global-registry aria-label="3.2 Global registry">3.2 Global registry</a></li></ul></li><li><a href=#4meters aria-label=4.Meters>4.Meters</a></li><li><a href=#5naming-meters aria-label="5.Naming meters">5.Naming meters</a><ul><li><a href=#51-tag-naming aria-label="5.1 Tag naming">5.1 Tag naming</a></li><li><a href=#52-common-tags aria-label="5.2 Common tags">5.2 Common tags</a></li><li><a href=#53-tag-values aria-label="5.3 Tag values">5.3 Tag values</a></li></ul></li><li><a href=#6-meter-filters aria-label="6. Meter filters">6. Meter filters</a><ul><li><a href=#61-denyaccept-meters aria-label="6.1 Deny/accept meters">6.1 Deny/accept meters</a></li><li><a href=#611-convenience-methods aria-label="6.11 Convenience methods">6.11 Convenience methods</a></li><li><a href=#612-chaining-denyaccept-meters aria-label="6.12 Chaining deny/accept meters">6.12 Chaining deny/accept meters</a></li></ul></li><li><a href=#62-transforming-metrics aria-label="6.2 Transforming metrics">6.2 Transforming metrics</a></li><li><a href=#63-configuring-distribution-statistics aria-label="6.3 Configuring distribution statistics">6.3 Configuring distribution statistics</a></li><li><a href=#7-rate-aggregation aria-label="7. Rate aggregation">7. Rate aggregation</a></li><li><a href=#8-counters aria-label="8. Counters">8. Counters</a><ul><li><a href=#81-function-tracking-counters aria-label="8.1 Function-tracking counters">8.1 Function-tracking counters</a></li></ul></li><li><a href=#9-guages aria-label="9. Guages">9. Guages</a><ul><li><a href=#91-manually-incrementingdecrementing-a-guage aria-label="9.1 Manually incrementing/decrementing a Guage">9.1 Manually incrementing/decrementing a Guage</a></li><li><a href=#92-gauge-fluent-builder aria-label="9.2 Gauge fluent builder">9.2 Gauge fluent builder</a></li><li><a href=#93-why-is-my-guage-reporting-nan-or-disapperaring aria-label="9.3 Why is my guage reporting NaN or disapperaring">9.3 Why is my guage reporting NaN or disapperaring</a></li><li><a href=#94-multi-gauge aria-label="9.4 Multi-gauge">9.4 Multi-gauge</a></li></ul></li><li><a href=#10-timmers aria-label="10. Timmers">10. Timmers</a><ul><li><a href=#101-recording-blocks-of-code aria-label="10.1 Recording blocks of code">10.1 Recording blocks of code</a></li><li><a href=#102-storing-start-state-in-timersample aria-label="10.2 Storing start state in Timer.Sample">10.2 Storing start state in Timer.Sample</a></li><li><a href=#103-the-timed-annotation aria-label="10.3 The @Timed annotation">10.3 The @Timed annotation</a></li><li><a href=#104-function-tracking-timers aria-label="10.4 Function-tracking timers">10.4 Function-tracking timers</a></li><li><a href=#105-pause-detection aria-label="10.5 Pause detection">10.5 Pause detection</a></li><li><a href=#106-memory-footprint-estimation aria-label="10.6 Memory footprint estimation">10.6 Memory footprint estimation</a></li><li><a href=#11-distribution-summaries aria-label="11. Distribution summaries">11. Distribution summaries</a></li><li><a href=#111-scaling-and-histograms aria-label="11.1 Scaling and histograms">11.1 Scaling and histograms</a></li><li><a href=#112-memory-footprint-estimation aria-label="11.2 Memory footprint estimation">11.2 Memory footprint estimation</a></li></ul></li><li><a href=#12-long-task-timers aria-label="12. Long task timers">12. Long task timers</a></li><li><a href=#13-histograms-and-percentiles aria-label="13. Histograms and percentiles">13. Histograms and percentiles</a></li><li><a href=#%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%a6%82%e5%bf%b5%e5%92%8c%e4%be%8b%e5%ad%90%e8%bf%87%e4%ba%86%e4%b8%80%e9%81%8d%e7%8e%b0%e5%9c%a8%e5%86%99%e4%b8%80%e4%b8%8bdemo aria-label=基本的概念和例子过了一遍，现在写一下DEMO>基本的概念和例子过了一遍，现在写一下DEMO</a></li></ul></div></details></div><div class=post-content><h1 id=1什么是-micrometer>1.什么是 Micrometer<a hidden class=anchor aria-hidden=true href=#1什么是-micrometer>#</a></h1><ul><li>针对JVM Application的指标库工具</li><li>SPI 服务商应用接口</li></ul><h1 id=2支持的服务商>2.支持的服务商<a hidden class=anchor aria-hidden=true href=#2支持的服务商>#</a></h1><ul><li>AppOptics</li><li>Atlas</li><li>Azure Monitor</li><li>Cloudwatch</li><li>Datadog</li><li>Datadog StatsD</li><li>Dynatrace</li><li>Elastic</li><li>Humio</li><li>Influx</li><li>KairosDB</li><li>New Relic</li><li>Prometheus</li><li>SignalFx</li><li>Sysdig StatsD</li><li>Telegraf StatsD</li><li>Wavefront</li></ul><h1 id=3注册-registry>3.注册 Registry<a hidden class=anchor aria-hidden=true href=#3注册-registry>#</a></h1><ul><li>Meter是测量你的应用程序指标的一个集合</li><li>Meter在Micrometer中被MeterRegistry创建并保存</li><li>每个受支持的监控服务商都有一套对应的MeterRegistry实现</li><li>SimpleMeterRegistry可以将数据保存在内存中,不会将数据导出到任何地方</li><li>假如没有首选监控系统，可以从SimpleMeterRegistry开始</li><li><code>MeterRegistry registry = new SimpleMeterRegistry();</code></li><li><code>SimpleMeterRegistry</code>可以在Springboot中直接注入</li></ul><h2 id=31-composite-registries>3.1 Composite registries<a hidden class=anchor aria-hidden=true href=#31-composite-registries>#</a></h2><ul><li>提供了CompositeMeterRegistry，可以添加多个注册表</li><li>通过CompositeMeterRegistry可以将指标推送到多个监控系统</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 声明一个复合注册表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>CompositeMeterRegistry</span> <span class=n>composite</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CompositeMeterRegistry</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 从复合注册表声明一个名为counter的计数器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Counter</span> <span class=n>compositeCounter</span> <span class=o>=</span> <span class=n>composite</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;counter&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 计数器增1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>compositeCounter</span><span class=o>.</span><span class=na>increment</span><span class=o>();</span> 
</span></span><span class=line><span class=cl><span class=c1>// 简单注册表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SimpleMeterRegistry</span> <span class=n>simple</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleMeterRegistry</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 将简单注册表加入复合注册表中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>composite</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>simple</span><span class=o>);</span> <span class=o>(</span><span class=n>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 简单注册表和复合注册表的计数器都会累加1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>compositeCounter</span><span class=o>.</span><span class=na>increment</span><span class=o>();</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=32-global-registry>3.2 Global registry<a hidden class=anchor aria-hidden=true href=#32-global-registry>#</a></h2><ul><li><p>提供一个全局静态的注册表以及一组用于基于此注册表生成仪表的静态生成器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>MyComponent</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Counter</span> <span class=n>featureCounter</span> <span class=o>=</span> <span class=n>Metrics</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;feature&#34;</span><span class=o>,</span> <span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>);</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>feature</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>featureCounter</span><span class=o>.</span><span class=na>increment</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>feature2</span><span class=o>(</span><span class=n>String</span> <span class=n>type</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Metrics</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;feature.2&#34;</span><span class=o>,</span> <span class=s>&#34;type&#34;</span><span class=o>,</span> <span class=n>type</span><span class=o>).</span><span class=na>increment</span><span class=o>();</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>MyApplication</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// wire your monitoring system to global static state
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Metrics</span><span class=o>.</span><span class=na>addRegistry</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleMeterRegistry</span><span class=o>());</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h1 id=4meters>4.Meters<a hidden class=anchor aria-hidden=true href=#4meters>#</a></h1><ul><li>Micrometer 提供了仪表集合</li><li>Timer</li><li>Counter</li><li>Gauge</li><li>DistributionSummary</li><li>LongTaskTimer</li><li>FunctionCounter</li><li>FUnctionTimer</li><li>TimeGauge</li><li>不同的仪表类型导致不同数量的时间序列指标</li></ul><h1 id=5naming-meters>5.Naming meters<a hidden class=anchor aria-hidden=true href=#5naming-meters>#</a></h1><ul><li>用 . 分割最小单词</li><li>比如在代码中`registry.timer(&ldquo;http.server.requests&rdquo;)</li><li>传入prometheus就会变为<code>http_server_requests_duration_seconds</code></li></ul><h2 id=51-tag-naming>5.1 Tag naming<a hidden class=anchor aria-hidden=true href=#51-tag-naming>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;database.calls&#34;</span><span class=o>,</span> <span class=s>&#34;db&#34;</span><span class=o>,</span> <span class=s>&#34;users&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>counter</span><span class=o>(</span><span class=s>&#34;http.requests&#34;</span><span class=o>,</span> <span class=s>&#34;uri&#34;</span><span class=o>,</span> <span class=s>&#34;/api/users&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>可以从tag推测出测量的指标数据表示的内容为推荐命名方法</p><h2 id=52-common-tags>5.2 Common tags<a hidden class=anchor aria-hidden=true href=#52-common-tags>#</a></h2><ul><li>可以在注册表级别定义公共标签</li><li>registry.config().commonTags(&ldquo;stack&rdquo;,&ldquo;prod&rdquo;,&ldquo;region&rdquo;,&ldquo;us-east-l&rdquo;)</li><li>registry.config().commonTags(Arrays.asList(Tag.of(&ldquo;stack&rdquo;, &ldquo;prod&rdquo;), Tag.of(&ldquo;region&rdquo;, &ldquo;us-east-1&rdquo;)))</li><li>如果在Spring环境中，请通过添加MeterRegistryCustomizer bean添加通用标签，以确保在自动配置仪表绑定程序之前应用了通用标签。</li></ul><h2 id=53-tag-values>5.3 Tag values<a hidden class=anchor aria-hidden=true href=#53-tag-values>#</a></h2><ul><li>value必须非空</li></ul><h1 id=6-meter-filters>6. Meter filters<a hidden class=anchor aria-hidden=true href=#6-meter-filters>#</a></h1><ul><li>过滤功能</li><li>Deny</li><li>Transform</li><li>Configure</li></ul><h2 id=61-denyaccept-meters>6.1 Deny/accept meters<a hidden class=anchor aria-hidden=true href=#61-denyaccept-meters>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>MeterFilter</span><span class=o>(){</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>MeterFilterReply</span> <span class=nf>accept</span><span class=o>(</span><span class=n>Meter</span><span class=o>.</span><span class=na>Id</span> <span class=n>id</span><span class=o>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=o>(</span><span class=n>id</span><span class=o>.</span><span class=na>getName</span><span class=o>().</span><span class=na>contains</span><span class=o>(</span><span class=s>&#34;test&#34;</span><span class=o>)){</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>MeterFilterReply</span><span class=o>.</span><span class=na>DENY</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>MeterFilterReply</span><span class=o>.</span><span class=na>NEUTRAL</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>MeterFilterReply.DENY 请勿注册该仪表</li><li>MeterFilterReply.NEUTRAL 如果没有其他仪表过滤器返回DENY，则仪表的注册将照常进行</li><li>MeterFIlterReply.ACCEPT 如果过滤器返回“接受”，仪表将立即注册，而不会询问任何其他过滤器的接受方法</li></ul><h2 id=611-convenience-methods>6.11 Convenience methods<a hidden class=anchor aria-hidden=true href=#611-convenience-methods>#</a></h2><p>MeterFIlter 为拒绝/接受类型过滤器提供了几个方便的静态生成器</p><ul><li>accept()</li><li>accept(Predicate&lt;Meter.id>)</li><li>acceptNameStartsWith(String)</li><li>deny()</li><li>deny(Predicate&lt;Meter.id>)</li><li>denyNameStartsWith(String)</li><li>maximumAllowableMetrics(int) 达到一定数量后拒绝</li><li>maximumAllowableTags(String meterNamePrefix,String tagKey,int maximumTagValues,MeterFilter) 匹配tag</li><li>denyUnless(Predicate&lt;Meter.Id>)</li></ul><h2 id=612-chaining-denyaccept-meters>6.12 Chaining deny/accept meters<a hidden class=anchor aria-hidden=true href=#612-chaining-denyaccept-meters>#</a></h2><p>如下，该注册表中仅存名称包含http的指标</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>config</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>meterFilter</span><span class=o>(</span><span class=n>MeterFilter</span><span class=o>.</span><span class=na>acceptNameStartsWith</span><span class=o>(</span><span class=s>&#34;http&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>meterFilter</span><span class=o>(</span><span class=n>MeterFilter</span><span class=o>.</span><span class=na>deny</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=62-transforming-metrics>6.2 Transforming metrics<a hidden class=anchor aria-hidden=true href=#62-transforming-metrics>#</a></h1><p>该过滤器有条件地向仪表添加以名称“ test”开头的名称前缀和附加标签。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>MeterFilter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Meter</span><span class=o>.</span><span class=na>Id</span> <span class=nf>map</span><span class=o>(</span><span class=n>Meter</span><span class=o>.</span><span class=na>Id</span> <span class=n>id</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span><span class=o>(</span><span class=n>id</span><span class=o>.</span><span class=na>getName</span><span class=o>().</span><span class=na>startsWith</span><span class=o>(</span><span class=s>&#34;test&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>id</span><span class=o>.</span><span class=na>withName</span><span class=o>(</span><span class=s>&#34;extra.&#34;</span> <span class=o>+</span> <span class=n>id</span><span class=o>.</span><span class=na>getName</span><span class=o>()).</span><span class=na>withTag</span><span class=o>(</span><span class=s>&#34;extra.tag&#34;</span><span class=o>,</span> <span class=s>&#34;value&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>       <span class=o>}</span>
</span></span><span class=line><span class=cl>       <span class=k>return</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>commonTags(Iterable&lt;Tag>)</code></li><li>ignoreTags(String&mldr;)</li><li>replaceTagValues(String tagKey,Function&lt;String,String>replcaement,String&mldr;exceptions)</li><li>renameTag(String meterNamePrefix,String fromTagKey,String toTagKey)</li></ul><h1 id=63-configuring-distribution-statistics>6.3 Configuring distribution statistics<a hidden class=anchor aria-hidden=true href=#63-configuring-distribution-statistics>#</a></h1><ul><li>除了可以通过过滤器配置的计数，总计和最大值的基本知识外，Timer和DistributionSummary还包含一组可选的分配统计信息。</li><li>这些分布统计信息包括预先计算的百分位数，SLA和直方图。</li><li>通常，您应该仅使用要配置的部分创建一个新的DistributionStatisticConfig，然后将其与输入配置合并。</li><li>这使您可以下拉到注册表提供的分发统计信息的默认值，并将多个过滤器链接在一起，每个过滤器都配置了分发统计信息的某些部分</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span> <span class=n>MeterFilter</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>DistributionStatisticConfig</span> <span class=nf>configure</span><span class=o>(</span><span class=n>Meter</span><span class=o>.</span><span class=na>Id</span> <span class=n>id</span><span class=o>,</span> <span class=n>DistributionStatisticConfig</span> <span class=n>config</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>id</span><span class=o>.</span><span class=na>getName</span><span class=o>().</span><span class=na>startsWith</span><span class=o>(</span><span class=n>prefix</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>DistributionStatisticConfig</span><span class=o>.</span><span class=na>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>publishPercentiles</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>9</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>95</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>build</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>merge</span><span class=o>(</span><span class=n>config</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>config</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>maxExpected(Duration/long)</li><li>minExpected(Duration/long)</li></ul><h1 id=7-rate-aggregation>7. Rate aggregation<a hidden class=anchor aria-hidden=true href=#7-rate-aggregation>#</a></h1><p>pass</p><h1 id=8-counters>8. Counters<a hidden class=anchor aria-hidden=true href=#8-counters>#</a></h1><p>计数器报告一个指标，一个计数。计数器界面允许您以固定数量递增，该数量必须为正。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Counter</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>Counter</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;counter&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>baseUnit</span><span class=o>(</span><span class=s>&#34;beans&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this counter does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=81-function-tracking-counters>8.1 Function-tracking counters<a hidden class=anchor aria-hidden=true href=#81-function-tracking-counters>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MyCounterState</span> <span class=n>state</span> <span class=o>=</span> <span class=o>...;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FunctionCounter</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>FunctionCounter</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;counter&#34;</span><span class=o>,</span> <span class=n>state</span><span class=o>,</span> <span class=n>state</span> <span class=o>-&gt;</span> <span class=n>state</span><span class=o>.</span><span class=na>count</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>baseUnit</span><span class=o>(</span><span class=s>&#34;beans&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this counter does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=9-guages>9. Guages<a hidden class=anchor aria-hidden=true href=#9-guages>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>list</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>gauge</span><span class=o>(</span><span class=s>&#34;listGauge&#34;</span><span class=o>,</span> <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>(),</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(),</span> <span class=n>List</span><span class=o>::</span><span class=n>size</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>list2</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>gaugeCollectionSize</span><span class=o>(</span><span class=s>&#34;listSize2&#34;</span><span class=o>,</span> <span class=n>Tags</span><span class=o>.</span><span class=na>empty</span><span class=o>(),</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;());</span>
</span></span><span class=line><span class=cl><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>gaugeMapSize</span><span class=o>(</span><span class=s>&#34;mapGauge&#34;</span><span class=o>,</span> <span class=n>Tags</span><span class=o>.</span><span class=na>empty</span><span class=o>(),</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;());</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=91-manually-incrementingdecrementing-a-guage>9.1 Manually incrementing/decrementing a Guage<a hidden class=anchor aria-hidden=true href=#91-manually-incrementingdecrementing-a-guage>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// maintain a reference to myGauge
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>AtomicInteger</span> <span class=n>myGauge</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>gauge</span><span class=o>(</span><span class=s>&#34;numberGauge&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ... elsewhere you can update the value it holds using the object reference
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>myGauge</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>27</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>myGauge</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=n>11</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=92-gauge-fluent-builder>9.2 Gauge fluent builder<a hidden class=anchor aria-hidden=true href=#92-gauge-fluent-builder>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Gauge</span> <span class=n>gauge</span> <span class=o>=</span> <span class=n>Gauge</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;gauge&#34;</span><span class=o>,</span> <span class=n>myObj</span><span class=o>,</span> <span class=n>myObj</span><span class=o>::</span><span class=n>gaugeValue</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this gauge does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=93-why-is-my-guage-reporting-nan-or-disapperaring>9.3 Why is my guage reporting NaN or disapperaring<a hidden class=anchor aria-hidden=true href=#93-why-is-my-guage-reporting-nan-or-disapperaring>#</a></h2><p>pass</p><h2 id=94-multi-gauge>9.4 Multi-gauge<a hidden class=anchor aria-hidden=true href=#94-multi-gauge>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// SELECT count(*) from job group by status WHERE job = &#39;dirty&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MultiGauge</span> <span class=n>statuses</span> <span class=o>=</span> <span class=n>MultiGauge</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;statuses&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s>&#34;job&#34;</span><span class=o>,</span> <span class=s>&#34;dirty&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;The number of widgets in various statuses&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>baseUnit</span><span class=o>(</span><span class=s>&#34;widgets&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// run this periodically whenever you re-run your query
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>statuses</span><span class=o>.</span><span class=na>register</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>resultSet</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>result</span> <span class=o>-&gt;</span> <span class=n>Row</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>Tags</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;status&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>.</span><span class=na>getAsString</span><span class=o>(</span><span class=s>&#34;status&#34;</span><span class=o>)),</span> <span class=n>result</span><span class=o>.</span><span class=na>getAsInt</span><span class=o>(</span><span class=s>&#34;count&#34;</span><span class=o>))));</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=10-timmers>10. Timmers<a hidden class=anchor aria-hidden=true href=#10-timmers>#</a></h1><ul><li>计时器用于测量短时延以及此类事件的频率。</li><li>Timer的所有实现至少将总时间和事件计数报告为单独的时间序列。</li><li>尽管可以将Timers用于其他用例，但请注意不支持负值，并且记录更长的持续时间可能会导致总时间溢出Long.MAX_VALUE纳秒（292.3年）。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Timer</span> <span class=n>timer</span> <span class=o>=</span> <span class=n>Timer</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;my.timer&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this timer does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=101-recording-blocks-of-code>10.1 Recording blocks of code<a hidden class=anchor aria-hidden=true href=#101-recording-blocks-of-code>#</a></h2><ul><li>The <code>Timer</code> interface exposes several convenience overloads for recording timings inline</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>timer</span><span class=o>.</span><span class=na>record</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>dontCareAboutReturnValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl><span class=n>timer</span><span class=o>.</span><span class=na>recordCallable</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>returnValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Runnable</span> <span class=n>r</span> <span class=o>=</span> <span class=n>timer</span><span class=o>.</span><span class=na>wrap</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>dontCareAboutReturnValue</span><span class=o>());</span> <span class=o>(</span><span class=n>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>Callable</span> <span class=n>c</span> <span class=o>=</span> <span class=n>timer</span><span class=o>.</span><span class=na>wrap</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=n>returnValue</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=102-storing-start-state-in-timersample>10.2 Storing start state in Timer.Sample<a hidden class=anchor aria-hidden=true href=#102-storing-start-state-in-timersample>#</a></h2><ul><li>您也可以将启动状态存储在一个示例实例中，以后可以将其停止。</li><li>该示例根据注册表的时钟记录开始时间。开始采样后，执行要计时的代码，并通过对采样调用stop（Timer）来完成操作。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Timer</span><span class=o>.</span><span class=na>Sample</span> <span class=n>sample</span> <span class=o>=</span> <span class=n>Timer</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// do stuff
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sample</span><span class=o>.</span><span class=na>stop</span><span class=o>(</span><span class=n>registry</span><span class=o>.</span><span class=na>timer</span><span class=o>(</span><span class=s>&#34;my.timer&#34;</span><span class=o>,</span> <span class=s>&#34;response&#34;</span><span class=o>,</span> <span class=n>response</span><span class=o>.</span><span class=na>status</span><span class=o>()));</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=103-the-timed-annotation>10.3 The @Timed annotation<a hidden class=anchor aria-hidden=true href=#103-the-timed-annotation>#</a></h2><ul><li>核心模块包含@Timed批注，框架可使用该批注为特定类型的方法（例如为Web请求端点提供服务的方法）或通常为所有方法添加计时支持。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ExampleService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Timed</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sync</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// @Timed will record the execution time of this method,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// from the start and until it exits normally or exceptionally.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nd>@Async</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Timed</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;?&gt;</span> <span class=n>async</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// @Timed will record the execution time of this method,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// from the start and until the returned CompletableFuture
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// completes normally or exceptionally.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(...);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=104-function-tracking-timers>10.4 Function-tracking timers<a hidden class=anchor aria-hidden=true href=#104-function-tracking-timers>#</a></h2><ul><li>提供了一种更不常用的计时器模式，该模式可跟踪两个单调递增的函数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>IMap</span><span class=o>&lt;?,</span> <span class=o>?&gt;</span> <span class=n>cache</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FunctionTimer</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;cache.gets.latency&#34;</span><span class=o>,</span> <span class=n>cache</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>-&gt;</span> <span class=n>c</span><span class=o>.</span><span class=na>getLocalMapStats</span><span class=o>().</span><span class=na>getGetOperationCount</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>-&gt;</span> <span class=n>c</span><span class=o>.</span><span class=na>getLocalMapStats</span><span class=o>().</span><span class=na>getTotalGetLatency</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>NANOSECONDS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=n>cache</span><span class=o>.</span><span class=na>getName</span><span class=o>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;Cache gets&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=105-pause-detection>10.5 Pause detection<a hidden class=anchor aria-hidden=true href=#105-pause-detection>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>config</span><span class=o>().</span><span class=na>pauseDetector</span><span class=o>(</span><span class=k>new</span> <span class=n>ClockDriftPauseDetector</span><span class=o>(</span><span class=n>sleepInterval</span><span class=o>,</span> <span class=n>pauseThreshold</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>registry</span><span class=o>.</span><span class=na>config</span><span class=o>().</span><span class=na>pauseDetector</span><span class=o>(</span><span class=k>new</span> <span class=n>NoPauseDetector</span><span class=o>());</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=106-memory-footprint-estimation>10.6 Memory footprint estimation<a hidden class=anchor aria-hidden=true href=#106-memory-footprint-estimation>#</a></h2><p>pass</p><h2 id=11-distribution-summaries>11. Distribution summaries<a hidden class=anchor aria-hidden=true href=#11-distribution-summaries>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DistributionSummary</span> <span class=n>summary</span> <span class=o>=</span> <span class=n>DistributionSummary</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;response.size&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this summary does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>baseUnit</span><span class=o>(</span><span class=s>&#34;bytes&#34;</span><span class=o>)</span> <span class=c1>// optional (1)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>scale</span><span class=o>(</span><span class=n>100</span><span class=o>)</span> <span class=c1>// optional (2)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=111-scaling-and-histograms>11.1 Scaling and histograms<a hidden class=anchor aria-hidden=true href=#111-scaling-and-histograms>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DistributionSummary</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;my.ratio&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>scale</span><span class=o>(</span><span class=n>100</span><span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>sla</span><span class=o>(</span><span class=n>70</span><span class=o>,</span> <span class=n>80</span><span class=o>,</span> <span class=n>90</span><span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=112-memory-footprint-estimation>11.2 Memory footprint estimation<a hidden class=anchor aria-hidden=true href=#112-memory-footprint-estimation>#</a></h2><p>pass</p><h1 id=12-long-task-timers>12. Long task timers<a hidden class=anchor aria-hidden=true href=#12-long-task-timers>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Timed</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;aws.scrape&#34;</span><span class=o>,</span> <span class=n>longTask</span> <span class=o>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Scheduled</span><span class=o>(</span><span class=n>fixedDelay</span> <span class=o>=</span> <span class=n>360000</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>scrapeResources</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// find instances, volumes, auto-scaling groups, etc...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LongTaskTimer</span> <span class=n>scrapeTimer</span> <span class=o>=</span> <span class=n>registry</span><span class=o>.</span><span class=na>more</span><span class=o>().</span><span class=na>longTaskTimer</span><span class=o>(</span><span class=s>&#34;scrape&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>scrapeResources</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>scrapeTimer</span><span class=o>.</span><span class=na>record</span><span class=o>(()</span> <span class=o>=&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// find instances, volumes, auto-scaling groups, etc...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LongTaskTimer</span> <span class=n>longTaskTimer</span> <span class=o>=</span> <span class=n>LongTaskTimer</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;long.task.timer&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;a description of what this timer does&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>tags</span><span class=o>(</span><span class=s>&#34;region&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>)</span> <span class=c1>// optional
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=13-histograms-and-percentiles>13. Histograms and percentiles<a hidden class=anchor aria-hidden=true href=#13-histograms-and-percentiles>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Timer</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;my.timer&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>publishPercentiles</span><span class=o>(</span><span class=n>0</span><span class=o>.</span><span class=na>5</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>95</span><span class=o>)</span> <span class=c1>// median and 95th percentile
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=o>.</span><span class=na>publishPercentileHistogram</span><span class=o>()</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>sla</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=n>100</span><span class=o>))</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>minimumExpectedValue</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=n>1</span><span class=o>))</span>
</span></span><span class=line><span class=cl>   <span class=o>.</span><span class=na>maximumExpectedValue</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>10</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=基本的概念和例子过了一遍现在写一下demo>基本的概念和例子过了一遍，现在写一下DEMO<a hidden class=anchor aria-hidden=true href=#基本的概念和例子过了一遍现在写一下demo>#</a></h1><p>首先引入依赖</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>  <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>io.micrometer<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>micrometer-registry-prometheus<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>1.6.5<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>io.micrometer<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>micrometer-core<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>1.6.5<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后搞一个配置类把指标加上<code>commonTag</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.yunzainfo.cloud.staruniverse.config</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io.micrometer.core.instrument.MeterRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.actuate.autoconfigure.endpoint.web.WebEndpointProperties</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.actuate.autoconfigure.metrics.MeterRegistryCustomizer</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Primary</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.HashSet</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Set</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MetricConfig</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 配置所有的指标前缀为
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// contextPath 去掉斜杠
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 可以少配置一个applicationName
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=n>MeterRegistryCustomizer</span><span class=o>&lt;</span><span class=n>MeterRegistry</span><span class=o>&gt;</span> <span class=nf>configurer</span><span class=o>(</span><span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${server.servlet.context-path}&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>contextPath</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>registry</span> <span class=o>-&gt;</span> <span class=n>registry</span><span class=o>.</span><span class=na>config</span><span class=o>().</span><span class=na>commonTags</span><span class=o>(</span><span class=s>&#34;application&#34;</span><span class=o>,</span> <span class=n>contextPath</span><span class=o>.</span><span class=na>replaceAll</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这里主要是不想在改properties了，直接返回一个BEAN
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Primary</span>
</span></span><span class=line><span class=cl>    <span class=n>WebEndpointProperties</span> <span class=nf>asd</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>WebEndpointProperties</span> <span class=n>properties</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WebEndpointProperties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>includes</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>includes</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>properties</span><span class=o>.</span><span class=na>getExposure</span><span class=o>().</span><span class=na>setInclude</span><span class=o>(</span><span class=n>includes</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>properties</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>好了，现在说一下go和java的exporter的区别</p><ul><li>用go写的exporter是放出了一个url，Prometheus在时间间隔内访问我的exporter_url来scrape数据</li><li>用java就是 <em>定时</em> 查询指标，然后放在内存里，micrometer 集成了Springboot ，所以不用自定义url/接口来返回数据进行刮取，他会把内存中的数据通过url放出去给prometheus收集</li></ul><p>实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.yunzainfo.cloud.staruniverse.service.impl</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>com.alibaba.fastjson.JSONObject</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>com.yunzainfo.cloud.staruniverse.dto.PersonDto</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>com.yunzainfo.cloud.staruniverse.service.MetricsTaskService</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io.micrometer.core.instrument.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.boot.context.event.ApplicationReadyEvent</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.context.event.EventListener</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.stereotype.Service</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>reactor.core.publisher.Flux</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.time.Duration</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.HashSet</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.List</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Set</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.stream.Collectors</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MetricsTaskServiceImpl</span> <span class=kd>implements</span> <span class=n>MetricsTaskService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=n>MeterRegistry</span> <span class=n>meterRegistry</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>PersonDto</span> <span class=n>personDto</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PersonDto</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>MultiGauge</span> <span class=n>g</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@EventListener</span><span class=o>(</span><span class=n>ApplicationReadyEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>mixMetrics</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>registerMetrics</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Flux</span><span class=o>.</span><span class=na>interval</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofSeconds</span><span class=o>(</span><span class=n>5</span><span class=o>)).</span><span class=na>map</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>pushToHTTP</span><span class=o>).</span><span class=na>subscribe</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>registerMetrics</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Counter</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;simulation.people.request&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;这是个计数器，只能加不能减&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s>&#34;sex&#34;</span><span class=o>,</span> <span class=s>&#34;男&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>,</span> <span class=s>&#34;30-50&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>meterRegistry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 注册可变动值需要保留引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>personDto</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Gauge</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;simulation.people.ages&#34;</span><span class=o>,</span> <span class=n>personDto</span><span class=o>,</span> <span class=n>personDto</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;这是一个可以变动的数值&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>meterRegistry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 多个可变动的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>g</span> <span class=o>=</span> <span class=n>MultiGauge</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;simulation.people.statuses&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s>&#34;job&#34;</span><span class=o>,</span> <span class=s>&#34;dirty&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;The number of widgets in various statuses&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>baseUnit</span><span class=o>(</span><span class=s>&#34;widgets&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>meterRegistry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setPeopleNumber</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// SELECT COUNT(*) FROM HTTP_REQUESTS WHERE SEX =&#39;男&#39; AND age &gt;= 30 AND age &lt;=50
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>meterRegistry</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;simulation.people.request&#34;</span><span class=o>).</span><span class=na>counter</span><span class=o>().</span><span class=na>increment</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setPeopleAge</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>personDto</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setStatus</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>PersonDto</span><span class=o>&gt;</span> <span class=n>hashSet</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>PersonDto</span> <span class=n>p1</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PersonDto</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>p1</span><span class=o>.</span><span class=na>setName</span><span class=o>(</span><span class=s>&#34;啊哈哈&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p1</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>p1</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=s>&#34;健康&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>PersonDto</span> <span class=n>p2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PersonDto</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>p2</span><span class=o>.</span><span class=na>setName</span><span class=o>(</span><span class=s>&#34;哇咔咔&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p2</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>p2</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=s>&#34;虚弱&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>PersonDto</span> <span class=n>p3</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PersonDto</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>p3</span><span class=o>.</span><span class=na>setName</span><span class=o>(</span><span class=s>&#34;咦嘻嘻&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>p3</span><span class=o>.</span><span class=na>setAge</span><span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>random</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>p3</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=s>&#34;亚健康&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hashSet</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>p1</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hashSet</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>p2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hashSet</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>p3</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>hashSet</span><span class=o>.</span><span class=na>stream</span><span class=o>().</span><span class=na>map</span><span class=o>(</span><span class=n>result</span> <span class=o>-&gt;</span> <span class=n>MultiGauge</span><span class=o>.</span><span class=na>Row</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>Tags</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;status&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>.</span><span class=na>getStatus</span><span class=o>()),</span> <span class=n>result</span><span class=o>.</span><span class=na>getAge</span><span class=o>())).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>()),</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>pushToHTTP</span><span class=o>(</span><span class=n>Long</span> <span class=n>l</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setPeopleNumber</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>setPeopleAge</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>setStatus</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>效果</p><p><img loading=lazy src=https://b3logfile.com/file/2021/04/image-5a0717f7.png alt=image.png></p><p><img loading=lazy src=https://b3logfile.com/file/2021/04/image-deec08e5.png alt=image.png></p><p><img loading=lazy src=https://b3logfile.com/file/2021/04/image-c65e31cc.png alt=image.png></p><p>结束，休息♨️!!!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://devcui.github.io/pokemon/tags/prometheus/>prometheus</a></li></ul><nav class=paginav><a class=prev href=https://devcui.github.io/pokemon/posts/k8s/k8s-probe/><span class=title>«</span><br><span>K8S服务健康检测(探针)</span></a>
<a class=next href=https://devcui.github.io/pokemon/posts/prometheus/prometheus-alerting/><span class=title>»</span><br><span>Prometheus Alerting</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on twitter" href="https://twitter.com/intent/tweet/?text=Micrometer%20Concepts&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f&hashtags=prometheus"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f&title=Micrometer%20Concepts&summary=Micrometer%20Concepts&source=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f&title=Micrometer%20Concepts"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on whatsapp" href="https://api.whatsapp.com/send?text=Micrometer%20Concepts%20-%20https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Micrometer Concepts on telegram" href="https://telegram.me/share/url?text=Micrometer%20Concepts&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fprometheus%2fmicrometer-concepts%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devcui.github.io/pokemon/>神奇宝贝大师的旅行日记</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>