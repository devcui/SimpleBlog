<!doctype html><html lang=cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>关于微前端实现原理与ngx-planet(二) | 神奇宝贝大师的旅行日记</title><meta name=keywords content="angular"><meta name=description content="Desc Text."><meta name=author content="cui"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="blog"><meta name=yandex-verification content="blog"><meta name=msvalidate.01 content="blog"><link crossorigin=anonymous href=/pokemon/assets/css/stylesheet.2068759a50238aee83375bc8cb602a1caff7316bea9cc81b83d90aeea0e276c5.css integrity="sha256-IGh1mlAjiu6DN1vIy2AqHK/3MWvqnMgbg9kK7qDidsU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/pokemon/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://devcui.github.io/pokemon/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://devcui.github.io/pokemon/images/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://devcui.github.io/pokemon/images/favicon.png><link rel=apple-touch-icon href=https://devcui.github.io/pokemon/images/favicon.png><link rel=mask-icon href=https://devcui.github.io/pokemon/images/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-213464061-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="关于微前端实现原理与ngx-planet(二)"><meta property="og:description" content="Desc Text."><meta property="og:type" content="article"><meta property="og:url" content="https://devcui.github.io/pokemon/posts/angular/ngxplanet2/"><meta property="og:image" content="https://devcui.github.io/pokemon/images/head.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-05T11:30:03+00:00"><meta property="article:modified_time" content="2021-12-05T11:30:03+00:00"><meta property="og:site_name" content="神奇宝贝大师的旅行日记"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://devcui.github.io/pokemon/images/head.png"><meta name=twitter:title content="关于微前端实现原理与ngx-planet(二)"><meta name=twitter:description content="Desc Text."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://devcui.github.io/pokemon/posts/"},{"@type":"ListItem","position":2,"name":"关于微前端实现原理与ngx-planet(二)","item":"https://devcui.github.io/pokemon/posts/angular/ngxplanet2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"关于微前端实现原理与ngx-planet(二)","name":"关于微前端实现原理与ngx-planet(二)","description":"Desc Text.","keywords":["angular"],"articleBody":"道标 准备好源码，然后跟着文章去看代码，在每个代码块的第一行，我都把 filename 写上了，并且打开了 gitalk。\n项目结构 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 - packages/planet |--src |--application |--planet-application-loader.spec.ts |--planet-application-loader.ts # 应用加载器 |--planet-application-ref.spec.ts |--planet-application-ref.ts # 应用的引用 |--planet-application.service.spec.ts |--planet-application.service.ts # 应用逻辑处理Service |--portal-application.spec.ts |--portal-application.ts # Portal应用 |--component |--planet-component-loader.spec.ts |--planet-component-loader.ts # 组件加载器 |--planet-component-ref.ts # 组件引用 |--plant-component.config.ts # 组件配置 |--empty |--empty.component.spec.ts |--empty.component.ts # 空组件 |--testing |--app1.module.ts # 测试用例 |--app2.module.ts |--applications.ts |--index.ts |--utils.ts |--assets-loader.spec.ts |--assets-loader.ts # 静态资源加载器 |--global-event-dispatcher.spec.ts |--global-event-dispatcher.ts # 全局事件调度器 |--global-planet.spec.ts |--global-planet.ts # 一些函数 |--helper.spec.ts |--helper.ts # 一些util函数 |--module.spec.ts |--module.ts # packager module |--planet.class.ts # 注入配置和InjectToken |--planet.spec.ts |--planet.ts # planet 对象，包含了注册，启动设置信息，实质为service |--public-api.ts # 桶 |--test.ts # 测试 |--karma.config.js # test config |--ng-package.json # packager scheme |--pakcage.json # npm |--tsconfig.lib.json # compiler config |--tsconfig.lib.prod.json # env=prod compiler config |--tsconfig.spec.json # test copiler config |--tslint.json # code lint rules 从 Portal 的 AppComponent 开始 1 2 3 4 5 // appcomponent.ts // 首先注入了 planet 对象 constructor( private planet: Planet, ) {} 1 2 3 4 5 // appcomponent.ts // 初始化AppComponent中配置Portal和Applications ngOnInit() { ... } 1 2 3 4 5 6 7 8 9 10 11 // appcomponent.ts // 设置PlanetApplicationLoader应用加载器的options this.planet.setOptions({ // switchMode switchMode: SwitchModes.coexist, // Application资源加载错误处理回调函数 errorHandler: (error) =\u003e { // thy组件库的通知组件，理解成alert吧 this.thyNotify.error(`错误`, \"加载资源失败\"); }, }); 1 2 3 4 5 6 // planet.class.ts // SiwtchModes枚举类，切换子应用的模式，默认切换会销毁，设置 coexist 后只会隐藏 export enum SwitchModes { default = \"default\", coexist = \"coexist\", } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // planet-application-loader.ts // Injectable直接注到模块里了(唯一),项目启动会通过Factory自行创建,所以不需要初始化 @Injectable({ providedIn: 'root' }) export class PlanetApplicationLoader { private firstLoad = true; private startRouteChangeEvent: PlanetRouterEvent; // 这里是ApplicationLoader中的option private options: PlanetOptions ...... } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // appcomponent.ts // 向planet注册了两个应用 this.planet.registerApps([ { // 子应用名 name: \"app1\", // 应用渲染的容器元素, 指定子应用显示在哪个元素内部 hostParent: \"#app-host-container\", // 宿主元素的 Class，也就是在子应用启动组件上追加的样式 hostClass: appHostClass, // 子应用路由路径前缀，根据这个匹配应用 routerPathPrefix: /\\/app1|app4/, // 脚本和样式文件路径前缀，多个脚本可以避免重复写同样的前缀 resourcePathPrefix: \"/static/app1/\", // 是否启用预加载，启动后刷新页面等当前页面的应用渲染完毕后预加载子应用 preload: settings.app1.preload, // 切换子应用的模式，默认切换会销毁，设置 coexist 后只会隐藏 switchMode: settings.app1.switchMode, // 是否串行加载脚本静态资源 loadSerial: true, // 样式前缀 stylePrefix: \"app1\", // 脚本资源文件 scripts: [\"main.js\"], // 样式资源文件 styles: [\"styles.css\"], // 应用程序打包后的脚本和样式文件替换 manifest: \"/static/app1/manifest.json\", // 附加数据，主要应用于业务，比如图标，子应用的颜色，显示名等个性化配置 extra: { name: \"应用1\", color: \"#ffa415\", }, }, ....... ]); 在看 planet.registerApps之前先看一下 GlobalPlanet\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // global-planet.ts // 浏览器window对象 declare const window: any; // interface export interface GlobalPlanet { // 这里是一个Map,key是String类型的，Value为应用的引用 apps: { [key: string]: PlanetApplicationRef }; // 基座模式，只需要一个Portal portalApplication?: PlanetPortalApplication; // 应用加载器 applicationLoader?: PlanetApplicationLoader; // service,函数 applicationService?: PlanetApplicationService; } // 全局变量，如果window.planet不为空那么就拿window.planet的值，不然就初始化一个app的map出来 export const globalPlanet: GlobalPlanet = (window.planet = window.planet || { apps: {}, }); // 先看一眼，下面会在回来看 export function defineApplication( name: string, options: BootstrapAppModule | BootstrapOptions ) { if (globalPlanet.apps[name]) { throw new Error(`${name} application has exist.`); } if (isFunction(options)) { options = { template: \"\", bootstrap: options as BootstrapAppModule, }; } const appRef = new PlanetApplicationRef(name, options as BootstrapOptions); globalPlanet.apps[name] = appRef; } 为了继续看defineApplication先看一个用例,这个用例是app1的main.ts中的\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // app1的 main.ts // 调用defineApplication 传入 // 1. app1, // 2.函数返回 ModuleRef 启动的模块 defineApplication('app1', { // template 为一个dom字符串 template: ``, // bootstrap 应用的加载点 bootstrap: (portalApp: PlanetPortalApplication) =\u003e { // platformBrowserDynamic 传入 Provider, Provider同于 app.module中的providers 提供服务用的，作者在这里插入了两个 值或对象 \u003e\u003e\u003e\u003e export declare const platformBrowserDynamic: (extraProviders?: StaticProvider[] | undefined) =\u003e PlatformRef; return platformBrowserDynamic([ // 其实提供服务也可以理解成有一个Context,把Value注入到Context中了，在项目中的Context中可以通过Inject方式来提取使用这个服务了 { provide: PlanetPortalApplication, // 注意这里传入的是 defineApplication 函数 第二参数options中 BootstrapAppModule中的回调参数 useValue: portalApp }, ... ]) // 引导AppModule模块,创建@NgModule实例也就是创建一个AppModule出来 .bootstrapModule(AppModule) .then(appModule =\u003e { // 最后返回Promise // 至此，第二参中的BootstrapAppModule结束 return appModule; }) .catch(error =\u003e { console.error(error); return null; }); } }); 好，现在返回defineApplication中去看看用两个参数做了些什么呢\n1 2 3 4 5 6 7 8 9 10 11 12 // planet-applicaiton.ref.ts // 这是第二参的类型 export interface BootstrapOptions { template: string; bootstrap: BootstrapAppModule; } // 第二参数中 bootstrap 要传入portalApp然后返回NgModuldeRef export type BootstrapAppModule = ( portalApp?: PlanetPortalApplication ) =\u003e Promise\u003cNgModuleRef\u003cany\u003e\u003e; 上面已经讲过怎么用了,下面看当调用时，包内发生了什么?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // global-planet.ts export function defineApplication( name: string, options: BootstrapAppModule | BootstrapOptions ) { // 首先，看看globalPlanet的app map中有没有加入过这个项目，也就是说，如果有10个应用，调用defineApplication时传入相同的第一参name,就会发生应用重复，无法分别当前需要加载的是哪个应用，作者在这里判断并抛出异常 if (globalPlanet.apps[name]) { throw new Error(`${name} application has exist.`); } // 其次，看options第二参数，是带template的Bootstrap函数还是直接就是bootstrap函数 if (isFunction(options)) { // 如果是函数，那么template为空，第二参数转化类型,options备用 options = { template: \"\", bootstrap: options as BootstrapAppModule, }; } // 这里比较关键了，通过name和options new了一个PlanetApplicationRef对象 const appRef = new PlanetApplicationRef(name, options as BootstrapOptions); // 将appRef也就是子applicaiton的引用加入globalPlanet.apps的map中，也就是window.planet.apps中,至于为什么，前面有提到 globalPlanet.apps[name] = appRef; } 看看如何 new 一个子应用引用对象吧~\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // planet-application-ref.ts export class PlanetApplicationRef{ ... private innerSelector: string; // 这里 将 innerSelector调用方式改为了 app.selector因为是私有变量嘛 public get selector() { return this.innerSelector; } // 首先，构造函数两个参数由defineApplication传递过来 constructor(name: string, options: BootstrapOptions) { // 传递一些值给当前对象的属性 this.name = name; if (options) { this.template = options.template; // 如果template被传入了 getTagNameByTemplate,由于是util不在赘述，这里拿到了标签名称，稍后看一个应用demo this.innerSelector = this.template ? getTagNameByTemplate(this.template) : null; // 将Promise也就是bootstrap Instance也传进来 this.appModuleBootstrap = options.bootstrap; } } 作者每一个属性名和变量的词语都非常精准，所以导致看代码的时候非常好看,非常干净,这也是 clean code 第一章所追求的,我所追求的代码风格，非常棒\n看一个 selecor 应用 demo\n1 2 3 4 5 6 7 8 9 10 11 // planet-application-loader.ts // 首先通过name获取ApplicationRef引用 private hideApp(planetApp: PlanetApplication) { const appRef = getPlanetApplicationRef(planetApp.name); // 获取插入的整体dom节点的document,通过selector const appRootElement = document.querySelector(appRef.selector || planetApp.selector); // 隐藏dom元素 if (appRootElement) { appRootElement.setAttribute('style', 'display:none;'); } } 好了，至此注册内容结束，总体来说就是把 name 和 template 放到 window 下的对象中的 map 里，在提供一个 boostrap 和 angular 的 main.ts 结合起来，将 instance 也存入 map 中\n再次回到 Portal 的 appcomponent,这次看细致一些 1 2 3 4 5 // portal appcomponent.ts // 注册了planet constructor( private planet: Planet, ) {} 看看初始化 plant 的时候，plant 内部是什么样子的\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // planet.ts // injectable -\u003e context @Injectable({ providedIn: 'root' }) export class Planet { ... // 看这里，当factory向context注入Planet时，发生了什么 constructor( private injector: Injector, private router: Router, // angular 提供InjectToken方式注入值 @Inject(PLANET_APPLICATIONS) @Optional() planetApplications: PlanetApplication[] // 为了解释，插入一段module.ts的代码 ---NgxPlanetModule : module.ts // 放出NgxPlanetModule export class NgxPlanetModule { // 引入模块既可以直接引入也可以NgxPlanetModule.forRoot(apps) // apps为静态的PlanetApplication集合，其实就是appcomponent中register的那个集合 // 标识为PLANET_APPLICATIONS理解成字符串就好了 // Inject(PLANET_APPLICATIONS)也就是拿到外部模块引用forRoot函数中传入的结合 static forRoot(apps: PlanetApplication[]): ModuleWithProviders\u003cNgxPlanetModule\u003e { return { ngModule: NgxPlanetModule, providers: [ { provide: PLANET_APPLICATIONS, useValue: apps } ] }; } } --- // 回到planet.ts ) { // 通过injector从context里提取出injectable过的service,注意，全局唯一service if (!this.planetApplicationService) { // 注意，这里service给了谁了,给了global下的applicationService,也就是window下的那个对象,这里可以点setApplicationService去看,前面看过globalPlanet了 setApplicationService(this.injector.get(PlanetApplicationService)); } // 如果forRoot传入了apps，那么注册 if (planetApplications) { // 调用注册函数 this.registerApps(planetApplications); } } // 由于construct中用injector获得了全局planetApplicationService实例，所以这里直接可以用了 registerApps\u003cTExtra\u003e(apps: PlanetApplication\u003cTExtra\u003e[]) { // 调用service的注册，将apps在向下传一层 this.planetApplicationService.register(apps); } } 看一下 service 中的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // planet-application.service.ts @Injectable({ providedIn: \"root\", }) export class PlanetApplicationService { // PlanetApplication集合 private apps: PlanetApplication[] = []; // PlanetApplication map private appsMap: { [key: string]: PlanetApplication } = {}; constructor(private http: HttpClient, private assetsLoader: AssetsLoader) { // 首先检测 global下的applicationService是不是已经有了，有了就抛异常，因为这里存的是apps列表，所以不能刷新他的引用使它变成新的对象,不然存储的注册application就没有了 if (getApplicationService()) { throw new Error( \"PlanetApplicationService has been injected in the portal, repeated injection is not allowed\" ); } } // 注册 register\u003cTExtra\u003e( appOrApps: PlanetApplication\u003cTExtra\u003e | PlanetApplication\u003cTExtra\u003e[] ) { // 单个application转数组,多个application直接返回数组 const apps = coerceArray(appOrApps); apps.forEach((app) =\u003e { // 判断是否注册过了application了 if (this.appsMap[app.name]) { throw new Error(`${app.name} has be registered.`); } // 将application加入apps数组和map中 this.apps.push(app); this.appsMap[app.name] = app; }); } } 至此，模块启动实例(bootstrap|@NgModule)和注册从main.ts,portal 的appcomponent.ts解析完毕 无论是启动实例或是应用列表，都存在了 global 下面，前一种存到了apps下，后一个，存到了applicationService的数组和 map 中\n第三次回到 portal 的 appcomponent register 下一行，调用了 start\n1 2 3 // appcomponent.ts // 调用planet的start this.planet.start(); 看看如何写的,这里我加入了一些 console 通过输出的内容分析一下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // plant.ts start() { this.subscription = this.router.events .pipe( filter(event =\u003e { return event instanceof NavigationEnd; }), map((event: NavigationEnd) =\u003e { return event.urlAfterRedirects || event.url; }), startWith(location.pathname), distinctUntilChanged(), ) .subscribe((url: string) =\u003e { console.log(url) this.planetApplicationLoader.reroute({ url: url }); }); } 以下是输出内容\n1 2 3 4 5 // construct是我在planetApplicationLoader构造函数里加入的console // 通过顺序验证了，当factory创建好了planetApplicationLoader后会立即执行构造函数中的内容，所以construct排第一 construct // subscript真正订阅到的路由字符串 planet.ts:103 /about 然后使用planetApplicationLoader.reroute({})去改变了planetApplicationLoader中的private routeChange$ = new Subject();\n由于 construct 先运行，所以先来看planetApplicationLoader的构造函数进行了什么操作\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 // planet-application-loader.ts constructor( // assetsLoader先不考虑，我猜大概是对应了angular静态资源目录进行操作的一个对象 private assetsLoader: AssetsLoader, // planetApplicationService 前面看到的service // 里面有register和app列表 private planetApplicationService: PlanetApplicationService, // ngZone https://hijiangtao.github.io/2020/01/17/Angular-Zone-Concepts/ 可以看这篇帖子，主要是关于变更检测机制的一个东西 // 简单来说 run runOutsideAngular两个函数，一个是进行变更检测，一个在zone之外运行不触发变更检测 private ngZone: NgZone, // 路由 router: Router, // injector injector: Injector, // 对页面上运行的angular应用程序的引用 applicationRef: ApplicationRef ) { // 这里类似planetApplicationService的检测,检测global中是否已经存在了loader加载器 // 那么ApplicationLoader什么时候被创建的呢，看看之前planetApplicationService在哪里创建的，它上面就是setApplicationLoader if (getApplicationLoader()) { throw new Error( 'PlanetApplicationLoader has been injected in the portal, repeated injection is not allowed' ); } // 设置一些参数 this.options = { // 应用是隐藏还是销毁 switchMode: SwitchModes.default, // 错误处理回调函数 errorHandler: (error: Error) =\u003e { console.error(error); } }; // 将zone传递给portalApp this.portalApp.ngZone = ngZone; // 当前application的引用传递给portalApp this.portalApp.applicationRef = applicationRef; // 路由传递 this.portalApp.router = router; // 这里我理解为把注入器传过来了，也就可以用injector来拿当前context的对象了 // 可能理解有误，请在下方留言告知 this.portalApp.injector = injector; // 一会儿在看如何共享事件调用的 this.portalApp.globalEventDispatcher = injector.get(GlobalEventDispatcher); // 将portalApp给global对象了 globalPlanet.portalApplication = this.portalApp; // 调用了一个关于路由的函数 this.setupRouteChange(); } 先看 this.portalApp 是什么\n1 2 // planet-application-loader.ts private portalApp = new PlanetPortalApplication(); new 了一个 portalApplication 对象对吧，这就是我们的基座 application 了，看看里面有什么\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // portal-application.ts export class PlanetPortalApplication\u003cTData = any\u003e { // 当前应用的引用 applicationRef: ApplicationRef; // 注入器 injector: Injector; // 路由 router: Router; // 变更检测 ngZone: NgZone; // 事件分发器 globalEventDispatcher: GlobalEventDispatcher; // 额外数据? data: TData; // 跳转函数,返回了一个Promise navigateByUrl( url: string | UrlTree, extras?: NavigationExtras ): Promise\u003cboolean\u003e { return this.ngZone.run(() =\u003e { return this.router.navigateByUrl(url, extras); }); } // ngZone.run 在变更检测区域内运行函数，这里不知道为何不 object.ngZone.run而是要写一个函数来包装 run\u003cT\u003e(fn: (...args: any[]) =\u003e T): T { return this.ngZone.run\u003cT\u003e(() =\u003e { return fn(); }); } // 全局性调用变化检测 // applicationRef可以通过attachView()将视图包含到变化检测中 // 可以用detachView()将视图移除变化检测 tick() { this.applicationRef.tick(); } } 好了，接下来看加载应用的核心函数setupRouteChange这个函数有点长\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 // planet-application-loader.ts private setupRouteChange() { // 当路由变化时，先思考，application-loader比start调用先创建，所以start后，页面定到/about路由，所以这里可以接收到/about this.routeChange$ .pipe( distinctUntilChanged((x, y) =\u003e { return (x \u0026\u0026 x.url) === (y \u0026\u0026 y.url); }), // 和其他打平操作符的主要区别是它具有取消效果。在每次发出时，会取消前一个内部 observable (你所提供函数的结果) 的订阅，然后订阅一个新的 observable switchMap(event =\u003e { return of(event).pipe( // 卸载应用程序并返回应加载的应用程序 map(() =\u003e { // 这里拿到{url:'/about'} this.startRouteChangeEvent = event; // 通过url找app ,PlanetApplication类型,用service中的app列表和 注册过的app的routerPathPrefix和url进行匹配 const shouldLoadApps = this.planetApplicationService.getAppsByMatchedUrl(event.url); // 这里拿到了需要卸载的应用,下面有讲 const shouldUnloadApps = this.getUnloadApps(shouldLoadApps); // 设置加载和卸载的application,这里传入了加载应用和卸卸载应用，并且放出了ob对象，估计是作者提供hook函数，想提供给我们在loading时做一些操作的自定义函数的hook // 使用的时候 planet.appsLoadingStart.subscribe就可以拿到了 this.appsLoadingStart$.next({ shouldLoadApps, shouldUnloadApps }); // 卸载,下面有讲 this.unloadApps(shouldUnloadApps, event); return shouldLoadApps; }), // 加载静态资源 switchMap(shouldLoadApps =\u003e { let hasAppsNeedLoadingAssets = false; const loadApps$ = shouldLoadApps.map(app =\u003e { // 获取当前app的状态 const appStatus = this.appsStatus.get(app); // 如果没有加载过，或者曾经加载错了 // 设置需要加载状态后使用assetsLoader去加载静态资源,稍后讲assetsLoader if ( !appStatus || appStatus === ApplicationStatus.assetsLoading || appStatus === ApplicationStatus.loadError ) { hasAppsNeedLoadingAssets = true; return this.ngZone.runOutsideAngular(() =\u003e { return this.startLoadAppAssets(app); }); } else { return of(app); } }); if (hasAppsNeedLoadingAssets) { this.loadingDone = false; } return loadApps$.length \u003e 0 ? forkJoin(loadApps$) : of([] as PlanetApplication[]); }), // 引导启动或展示application map(apps =\u003e { const apps$: Observable\u003cPlanetApplication\u003e[] = []; apps.forEach(app =\u003e { // 获取app状态 const appStatus = this.appsStatus.get(app); // 如果引导过了,也就是拿到过context了 if (appStatus === ApplicationStatus.bootstrapped) { apps$.push( of(app).pipe( tap(() =\u003e { // 展示app this.showApp(app); // 获取app引用 const appRef = getPlanetApplicationRef(app.name); // 路由跳转 router是从 applicationRef也就是子application中 inject出来的router,所以路由表完备 appRef.navigateByUrl(event.url); // 设置app状态为激活状态 this.setAppStatus(app, ApplicationStatus.active); // 加载结束 this.setLoadingDone(); }) ) ); } else if (appStatus === ApplicationStatus.assetsLoaded) { // 如果appStatus状态为静态资源加载完毕 apps$.push( of(app).pipe( switchMap(() =\u003e { // 引导app获取app context中的一些对象 return this.bootstrapApp(app).pipe( map(() =\u003e { // 设置app模式为激活状态 this.setAppStatus(app, ApplicationStatus.active); // 加载完毕 this.setLoadingDone(); return app; }) ); }) ) ); // 如果应用未激活状态 } else if (appStatus === ApplicationStatus.active) { apps$.push( of(app).pipe( tap(() =\u003e { // 获取引用 const appRef = getPlanetApplicationRef(app.name); // 获取当前路径 const currentUrl = appRef.getCurrentRouterStateUrl? appRef.getCurrentRouterStateUrl(): ''; // 如果当前url和 事件url不一致 if (currentUrl !== event.url) { // 路由跳转 appRef.navigateByUrl(event.url); } }) ) ); } else { throw new Error( `app(${app.name})'s status is ${appStatus}, can't be show or bootstrap` ); } }); if (apps$.length \u003e 0) { // 切换到应用后会有闪烁现象，所以使用 setTimeout 后启动应用 setTimeout(() =\u003e { // 此处判断是因为如果静态资源加载完毕还未启动被取消，还是会启动之前的应用，虽然可能性比较小，但是无法排除这种可能性，所以只有当 Event 是最后一个才会启动 if (this.startRouteChangeEvent === event) { this.ngZone.runOutsideAngular(() =\u003e { // 将apps中的ob们合并到一起执行后 forkJoin(apps$).subscribe(() =\u003e { // 设置加载完成状态 this.setLoadingDone(); // 然后去搞预加载,注册时传入的参数preload=tue/false this.ensurePreloadApps(apps); }); }); } }); } else { // 设置 this.ensurePreloadApps(apps); this.setLoadingDone(); } }), // 使用自定义异常hook function catchError(error =\u003e { this.errorHandler(error); return []; }) ); }) ) .subscribe(); } 然后看unload,bootstrap,destory,preload,show,hide,卸载，加载，销毁，预加载，展示，隐藏相关的这几个函数\n获取卸载 app\n1 2 3 4 5 6 7 8 9 10 11 12 13 // planet-applicaiton-loader.ts // 传入激活的application列表 private getUnloadApps(activeApps: PlanetApplication[]) { const unloadApps: PlanetApplication[] = []; this.appsStatus.forEach((value, app) =\u003e { // application状态为激活，但是激活列表中没有这个application if (value === ApplicationStatus.active \u0026\u0026 !activeApps.find(item =\u003e item.name === app.name)) { // 那么放入待卸载应用集合里 unloadApps.push(app); } }); return unloadApps; } 卸载\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // planet-applicaiton-loader.ts // 卸载applications,第一参为application集合,第二个参数类似{url:'/about'} private unloadApps(shouldUnloadApps: PlanetApplication[], event: PlanetRouterEvent) { const hideApps: PlanetApplication[] = []; const destroyApps: PlanetApplication[] = []; // 需要卸载的app看看是隐藏模式还是销毁模式 shouldUnloadApps.forEach(app =\u003e { // app.SwitchMode参数的两个值，在注册的时候设置的 // coexist模式 if (this.switchModeIsCoexist(app)) { hideApps.push(app); // 隐藏应用 this.hideApp(app); // 设置状态 this.setAppStatus(app, ApplicationStatus.bootstrapped); // default模式,销毁模式 } else { destroyApps.push(app); // 销毁之前先隐藏，否则会出现闪烁，因为 destroy 是延迟执行的 // 如果销毁不延迟执行，会出现切换到主应用的时候会有视图卡顿现象 this.hideApp(app); // --- // application应用状态有5个 // 资源加载状态分别是,我估计这里和预加载或者做判断有用到 \u003e\u003e assetsLoading = 1, // 资源被加载状态 assetsLoaded = 2, // 正在引导启动状态 bootstrapping = 3, // 已经被引导启动状态 bootstrapped = 4, // 激活状态 active = 5, // 加载失败 loadError = 10 --- this.setAppStatus(app, ApplicationStatus.assetsLoaded); } }); // 如果隐藏列表或销毁列表中有值 if (hideApps.length \u003e 0 || destroyApps.length \u003e 0) { // 从其他应用切换到主应用的时候会有视图卡顿现象，所以先等主应用渲染完毕后再加载其他应用 // 此处尝试使用 this.ngZone.onStable.pipe(take(1)) 应用之间的切换会出现闪烁 setTimeout(() =\u003e { // 这里还不太理解 hideApps.forEach(app =\u003e { const appRef = getPlanetApplicationRef(app.name); if (appRef) { appRef.navigateByUrl(event.url); } }); // 销毁app destroyApps.forEach(app =\u003e { this.destroyApp(app); }); }); } } 销毁\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // planet-application-loader.ts // 传入需要销毁的application private destroyApp(planetApp: PlanetApplication) { // 得到applicationRef的引用 const appRef = getPlanetApplicationRef(planetApp.name); if (appRef) { // 销毁 appRef.destroy(); } // 删除 document节点 const container = getHTMLElement(planetApp.hostParent); const appRootElement = container.querySelector((appRef \u0026\u0026 appRef.selector) || planetApp.selector); if (appRootElement) { container.removeChild(appRootElement); } } 显示和隐藏\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // planet-application-loader.ts private hideApp(planetApp: PlanetApplication) { const appRef = getPlanetApplicationRef(planetApp.name); // 拿到dom节点 const appRootElement = document.querySelector(appRef.selector || planetApp.selector); if (appRootElement) { // css隐藏 appRootElement.setAttribute('style', 'display:none;'); } } private showApp(planetApp: PlanetApplication) { const appRef = getPlanetApplicationRef(planetApp.name); // 拿到dom节点 const appRootElement = document.querySelector(appRef.selector || planetApp.selector); // 去除隐藏样式 if (appRootElement) { appRootElement.setAttribute('style', ''); } } 预加载\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 // planet-applicatin-loader.ts private ensurePreloadApps(activeApps?: PlanetApplication[]) { // 第一次加载的时候 对app进行预加载 if (this.firstLoad) { this.preloadApps(activeApps); this.firstLoad = false; } } private preloadApps(activeApps?: PlanetApplication[]) { setTimeout(() =\u003e { // 过滤preload为true的application const toPreloadApps = this.planetApplicationService.getAppsToPreload(activeApps ? activeApps.map(item =\u003e item.name) : null); // 加载 const loadApps$ = toPreloadApps.map(preloadApp =\u003e { return this.preloadInternal(preloadApp); }); // 对加载过程使用hooks错误处理 forkJoin(loadApps$).subscribe({ error: error =\u003e this.errorHandler(error) }); }); } // 第一参数application,第二参是否直接加载 private preloadInternal(app: PlanetApplication, immediate?: boolean): Observable\u003cPlanetApplicationRef\u003e { // 获取app状态 const status = this.appsStatus.get(app); // 如果没有状态或者加载错误 if (!status || status === ApplicationStatus.loadError) { return this.startLoadAppAssets(app).pipe( switchMap(() =\u003e { // 如果是直接加载 if (immediate) { // 在隐藏模式下加载 return this.bootstrapApp(app, 'hidden'); } else { // 如果不是直接加载 // 在状态监测之外 return this.ngZone.runOutsideAngular(() =\u003e { // 加载applicaiton return this.bootstrapApp(app, 'hidden'); }); } }), map(() =\u003e { // 返回application的引用 return getPlanetApplicationRef(app.name); }) ); // 如果在application属于其他状态 } else if ( [ApplicationStatus.assetsLoading, ApplicationStatus.assetsLoaded, ApplicationStatus.bootstrapping].includes( status ) ) { return this.appStatusChange.pipe( filter(event =\u003e { return event.app === app \u0026\u0026 event.status === ApplicationStatus.bootstrapped; }), take(1), map(() =\u003e { // 返回引用 return getPlanetApplicationRef(app.name); }) ); } else { // 异常 const appRef = getPlanetApplicationRef(app.name); if (!appRef) { throw new Error(`${app.name}'s status is ${ApplicationStatus[status]}, planetApplicationRef is null.`); } return of(appRef); } } bootstrap\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 // planet-application-loader.ts private bootstrapApp( app: PlanetApplication, defaultStatus: 'hidden' | 'display' = 'display' ): Observable\u003cPlanetApplicationRef\u003e { // 设置状态正在加载中 this.setAppStatus(app, ApplicationStatus.bootstrapping); // 获取app的引用 const appRef = getPlanetApplicationRef(app.name); // 如果注册了且boostrap函数不为空 if (appRef \u0026\u0026 appRef.bootstrap) { // 获取 宿主dom const container = getHTMLElement(app.hostParent); let appRootElement: HTMLElement; // 进行显示隐藏，加入前缀，宿主class的操作 if (container) { appRootElement = container.querySelector(appRef.selector || app.selector); if (!appRootElement) { if (appRef.template) { appRootElement = createElementByTemplate(appRef.template); } else { appRootElement = document.createElement(app.selector); } appRootElement.setAttribute('style', 'display:none;'); if (app.hostClass) { appRootElement.classList.add(...coerceArray(app.hostClass)); } if (app.stylePrefix) { appRootElement.classList.add(...coerceArray(app.stylePrefix)); } container.appendChild(appRootElement); } } // 加载 let result = appRef.bootstrap(this.portalApp); if (result['then']) { result = from(result) as Observable\u003cPlanetApplicationRef\u003e; } // 最后返回app引用 return result.pipe( tap(() =\u003e { this.setAppStatus(app, ApplicationStatus.bootstrapped); if (defaultStatus === 'display' \u0026\u0026 appRootElement) { appRootElement.removeAttribute('style'); } }), map(() =\u003e { return appRef; }) ); } else { throw new Error( `[${app.name}] not found, make sure that the app has the correct name defined use defineApplication(${app.name}) and runtimeChunk and vendorChunk are set to true, details see https://github.com/worktile/ngx-planet#throw-error-cannot-read-property-call-of-undefined-at-__webpack_require__-bootstrap79` ); } } app.Ref.bootstrap()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // planet-application-ref // 加载应用获取application的引用后返回自身 PlanetApplicationRef类型 bootstrap(app: PlanetPortalApplication): Observable\u003cthis\u003e { if (!this.appModuleBootstrap) { throw new Error(`app(${this.name}) is not defined`); } this.portalApp = app; // 使用main.ts中传入的bootstrap来加载app,然后拿到模块引用 return from( this.appModuleBootstrap(app).then(appModuleRef =\u003e { // 传递引用,然后复制一些自己想要的信息从appModuleRef中 this.appModuleRef = appModuleRef; // 传递name this.appModuleRef.instance.appName = this.name; this.syncPortalRouteWhenNavigationEnd(); // 返回 return this; }) ); } this.appModuleBootstrap是通过main.ts的defineApplication第二参数的bootstrap传入的,之前看过一下\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // global-planet.ts export function defineApplication( name: string, options: BootstrapAppModule | BootstrapOptions ) { if (globalPlanet.apps[name]) { throw new Error(`${name} application has exist.`); } if (isFunction(options)) { options = { template: \"\", bootstrap: options as BootstrapAppModule, }; } // 这里new了一个PlanetApplicationRef然后将引用传入了map中 const appRef = new PlanetApplicationRef(name, options as BootstrapOptions); globalPlanet.apps[name] = appRef; } this.appModuleBootstrap\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // planet-application-ref.ts export class PlanetApplicationRef { ... // 这里是global-planet new的对象时候传入的 private appModuleBootstrap: (app: PlanetPortalApplication) =\u003e Promise\u003cNgModuleRef\u003cany\u003e\u003e; ... constructor(name: string, options: BootstrapOptions) { this.name = name; if (options) { this.template = options.template; this.innerSelector = this.template ? getTagNameByTemplate(this.template) : null; // 具体传入 this.appModuleBootstrap = options.bootstrap; } } 至此，bootstrap 结束\nassetsLoader 之前在核心的setupRouteChange走第三步之前，中间有一个加载 assets 的阶段，毕竟子应用的main.ts应该是不能主动注册过来的,需要加载静态文件来获取，我是这么猜测的\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // planet-application-loader.ts switchMap((shouldLoadApps) =\u003e { let hasAppsNeedLoadingAssets = false; const loadApps$ = shouldLoadApps.map((app) =\u003e { const appStatus = this.appsStatus.get(app); if ( !appStatus || appStatus === ApplicationStatus.assetsLoading || appStatus === ApplicationStatus.loadError ) { hasAppsNeedLoadingAssets = true; return this.ngZone.runOutsideAngular(() =\u003e { // 核心调用,开始加载application的assets return this.startLoadAppAssets(app); }); } else { return of(app); } }); if (hasAppsNeedLoadingAssets) { this.loadingDone = false; } return loadApps$.length \u003e 0 ? forkJoin(loadApps$) : of([] as PlanetApplication[]); }); private startLoadAppAssets(app: PlanetApplication) { if (this.inProgressAppAssetsLoads.get(app.name)) { return this.inProgressAppAssetsLoads.get(app.name); } else { // assetsLoader.loadAppAssets 核心函数,调用完毕后看是否放入map中 const loadApp$ = this.assetsLoader.loadAppAssets(app).pipe( tap(() =\u003e { this.inProgressAppAssetsLoads.delete(app.name); // 设置加载完毕状态 this.setAppStatus(app, ApplicationStatus.assetsLoaded); }), map(() =\u003e { return app; }), catchError(error =\u003e { this.inProgressAppAssetsLoads.delete(app.name); // 加载失败状态 this.setAppStatus(app, ApplicationStatus.loadError); throw error; }), share() ); // 放入map中 this.inProgressAppAssetsLoads.set(app.name, loadApp$); // 设置状态为assetsLoading状态,这里要知道返回的ob所以写代码的时候Loaded在Loading上面，真正订阅subscribe的时候，顺序就对了 this.setAppStatus(app, ApplicationStatus.assetsLoading); return loadApp$; } } 调用了构造器注入的 assetsLoader 看一眼 loader 里咋写的吧\n关于 mainfest.json 看一看 https://jonny-huang.github.io/angular/training/19_pwa/ 有关于 PWA 方面的内容\n1 2 3 4 5 6 7 8 9 10 { \"main.js\": \"main-es2015.js\", \"main.js.map\": \"main-es2015.js.map\", \"polyfills-es5.js\": \"polyfills-es5-es2015.js\", \"polyfills-es5.js.map\": \"polyfills-es5-es2015.js.map\", \"polyfills.js\": \"polyfills-es2015.js\", \"polyfills.js.map\": \"polyfills-es2015.js.map\", \"styles.css\": \"styles.css\", \"styles.css.map\": \"styles.css.map\" } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 // load结果的接口类型 export interface AssetsLoadResult { src: string; hashCode: number; loaded: boolean; status: string; } // context注入,全剧唯一 @Injectable({ providedIn: \"root\", }) export class AssetsLoader { // 加载过的sources private loadedSources: number[] = []; // 获取http客户端 constructor(private http: HttpClient) {} // 加载script loadScript(src: string): Observable\u003cAssetsLoadResult\u003e { // hashCode const id = hashCode(src); // 通过hashCode判断是否加载过了这个js if (this.loadedSources.includes(id)) { return of({ src: src, hashCode: id, loaded: true, status: \"Loaded\", }); } // 然后构建","wordCount":"5333","inLanguage":"cn","datePublished":"2021-12-05T11:30:03Z","dateModified":"2021-12-05T11:30:03Z","author":{"@type":"Person","name":"cui"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://devcui.github.io/pokemon/posts/angular/ngxplanet2/"},"publisher":{"@type":"Organization","name":"神奇宝贝大师的旅行日记","logo":{"@type":"ImageObject","url":"https://devcui.github.io/pokemon/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://devcui.github.io/pokemon/ accesskey=h title="  (Alt + H)"><img src=https://devcui.github.io/pokemon/images/favicon.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://devcui.github.io/pokemon/posts title=列表><span>列表</span></a></li><li><a href=https://devcui.github.io/pokemon/categories title=分类><span>分类</span></a></li><li><a href=https://devcui.github.io/pokemon/tags title=标签><span>标签</span></a></li><li><a href=https://devcui.github.io/pokemon/series title=系列><span>系列</span></a></li><li><a href=https://devcui.github.io/pokemon/archives title=归档><span>归档</span></a></li><li><a href=https://devcui.github.io/pokemon/about title=关于><span>关于</span></a></li><li><a href=https://devcui.github.io/pokemon/sponsor title=赞助><span>赞助</span></a></li><li><a href=https://zukan.pokemon.co.jp/ title=图鉴><span>图鉴</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://devcui.github.io/pokemon/>Home</a>&nbsp;»&nbsp;<a href=https://devcui.github.io/pokemon/posts/>Posts</a></div><h1 class=post-title>关于微前端实现原理与ngx-planet(二)</h1><div class=post-description>Desc Text.</div><div class=post-meta><span title='2021-12-05 11:30:03 +0000 UTC'>December 5, 2021</span>&nbsp;·&nbsp;26 min&nbsp;·&nbsp;cui&nbsp;|&nbsp;<a href=https://github.com/devcui/pokemon/tree/master/content//posts/angular/ngxplanet2.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e9%81%93%e6%a0%87 aria-label=道标>道标</a></li><li><a href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84 aria-label=项目结构>项目结构</a></li><li><a href=#%e4%bb%8e-portal-%e7%9a%84-appcomponent-%e5%bc%80%e5%a7%8b aria-label="从 Portal 的 AppComponent 开始">从 Portal 的 AppComponent 开始</a></li><li><a href=#%e5%86%8d%e6%ac%a1%e5%9b%9e%e5%88%b0-portal-%e7%9a%84-appcomponent%e8%bf%99%e6%ac%a1%e7%9c%8b%e7%bb%86%e8%87%b4%e4%b8%80%e4%ba%9b aria-label="再次回到 Portal 的 appcomponent,这次看细致一些">再次回到 Portal 的 appcomponent,这次看细致一些</a></li><li><a href=#%e7%ac%ac%e4%b8%89%e6%ac%a1%e5%9b%9e%e5%88%b0-portal-%e7%9a%84-appcomponent aria-label="第三次回到 portal 的 appcomponent">第三次回到 portal 的 appcomponent</a></li><li><a href=#assetsloader aria-label=assetsLoader>assetsLoader</a></li><li><a href=#%e7%bb%84%e4%bb%b6%e6%b3%a8%e5%86%8c aria-label=组件注册>组件注册</a></li><li><a href=#%e4%ba%8b%e4%bb%b6%e6%b3%a8%e5%86%8c aria-label=事件注册>事件注册</a></li><li><a href=#end aria-label=END>END</a></li></ul></div></details></div><div class=post-content><h1 id=道标>道标<a hidden class=anchor aria-hidden=true href=#道标>#</a></h1><p>准备好源码，然后跟着文章去看代码，在每个代码块的第一行，我都把 filename 写上了，并且打开了 gitalk。</p><h1 id=项目结构>项目结构<a hidden class=anchor aria-hidden=true href=#项目结构>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>- packages/planet
</span></span><span class=line><span class=cl>|--src
</span></span><span class=line><span class=cl>    |--application
</span></span><span class=line><span class=cl>        |--planet-application-loader.spec.ts
</span></span><span class=line><span class=cl>        |--planet-application-loader.ts # 应用加载器
</span></span><span class=line><span class=cl>        |--planet-application-ref.spec.ts
</span></span><span class=line><span class=cl>        |--planet-application-ref.ts # 应用的引用
</span></span><span class=line><span class=cl>        |--planet-application.service.spec.ts
</span></span><span class=line><span class=cl>        |--planet-application.service.ts # 应用逻辑处理Service
</span></span><span class=line><span class=cl>        |--portal-application.spec.ts
</span></span><span class=line><span class=cl>        |--portal-application.ts  # Portal应用
</span></span><span class=line><span class=cl>    |--component
</span></span><span class=line><span class=cl>        |--planet-component-loader.spec.ts
</span></span><span class=line><span class=cl>        |--planet-component-loader.ts # 组件加载器
</span></span><span class=line><span class=cl>        |--planet-component-ref.ts # 组件引用
</span></span><span class=line><span class=cl>        |--plant-component.config.ts # 组件配置
</span></span><span class=line><span class=cl>    |--empty
</span></span><span class=line><span class=cl>        |--empty.component.spec.ts
</span></span><span class=line><span class=cl>        |--empty.component.ts   # 空组件
</span></span><span class=line><span class=cl>    |--testing
</span></span><span class=line><span class=cl>        |--app1.module.ts # 测试用例
</span></span><span class=line><span class=cl>        |--app2.module.ts
</span></span><span class=line><span class=cl>        |--applications.ts
</span></span><span class=line><span class=cl>        |--index.ts
</span></span><span class=line><span class=cl>        |--utils.ts
</span></span><span class=line><span class=cl>    |--assets-loader.spec.ts
</span></span><span class=line><span class=cl>    |--assets-loader.ts    # 静态资源加载器
</span></span><span class=line><span class=cl>    |--global-event-dispatcher.spec.ts
</span></span><span class=line><span class=cl>    |--global-event-dispatcher.ts   # 全局事件调度器
</span></span><span class=line><span class=cl>    |--global-planet.spec.ts
</span></span><span class=line><span class=cl>    |--global-planet.ts     # 一些函数
</span></span><span class=line><span class=cl>    |--helper.spec.ts
</span></span><span class=line><span class=cl>    |--helper.ts    # 一些util函数
</span></span><span class=line><span class=cl>    |--module.spec.ts
</span></span><span class=line><span class=cl>    |--module.ts    # packager module
</span></span><span class=line><span class=cl>    |--planet.class.ts  # 注入配置和InjectToken
</span></span><span class=line><span class=cl>    |--planet.spec.ts
</span></span><span class=line><span class=cl>    |--planet.ts    # planet 对象，包含了注册，启动设置信息，实质为service
</span></span><span class=line><span class=cl>    |--public-api.ts  # 桶
</span></span><span class=line><span class=cl>    |--test.ts # 测试
</span></span><span class=line><span class=cl>|--karma.config.js  # test config
</span></span><span class=line><span class=cl>|--ng-package.json  # packager scheme
</span></span><span class=line><span class=cl>|--pakcage.json     # npm
</span></span><span class=line><span class=cl>|--tsconfig.lib.json    # compiler config
</span></span><span class=line><span class=cl>|--tsconfig.lib.prod.json # env=prod compiler config
</span></span><span class=line><span class=cl>|--tsconfig.spec.json   # test copiler config
</span></span><span class=line><span class=cl>|--tslint.json  # code lint rules
</span></span></code></pre></td></tr></table></div></div><h1 id=从-portal-的-appcomponent-开始>从 Portal 的 AppComponent 开始<a hidden class=anchor aria-hidden=true href=#从-portal-的-appcomponent-开始>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 首先注入了 planet 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kr>private</span> <span class=nx>planet</span>: <span class=kt>Planet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 初始化AppComponent中配置Portal和Applications
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>ngOnInit() {</span>
</span></span><span class=line><span class=cl>       <span class=p>...</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 设置PlanetApplicationLoader应用加载器的options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>planet</span><span class=p>.</span><span class=nx>setOptions</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// switchMode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>switchMode</span>: <span class=kt>SwitchModes.coexist</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Application资源加载错误处理回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>errorHandler</span><span class=o>:</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// thy组件库的通知组件，理解成alert吧
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>thyNotify</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`错误`</span><span class=p>,</span> <span class=s2>&#34;加载资源失败&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet.class.ts
</span></span></span><span class=line><span class=cl><span class=c1>// SiwtchModes枚举类，切换子应用的模式，默认切换会销毁，设置 coexist 后只会隐藏
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>enum</span> <span class=nx>SwitchModes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>default</span> <span class=o>=</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>coexist</span> <span class=o>=</span> <span class=s2>&#34;coexist&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Injectable直接注到模块里了(唯一),项目启动会通过Factory自行创建,所以不需要初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>providedIn</span><span class=o>:</span> <span class=s1>&#39;root&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetApplicationLoader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>firstLoad</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>startRouteChangeEvent</span>: <span class=kt>PlanetRouterEvent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里是ApplicationLoader中的option
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>options</span>: <span class=kt>PlanetOptions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 向planet注册了两个应用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>planet</span><span class=p>.</span><span class=nx>registerApps</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 子应用名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;app1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 应用渲染的容器元素, 指定子应用显示在哪个元素内部
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hostParent</span><span class=o>:</span> <span class=s2>&#34;#app-host-container&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 宿主元素的 Class，也就是在子应用启动组件上追加的样式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hostClass</span>: <span class=kt>appHostClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 子应用路由路径前缀，根据这个匹配应用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>routerPathPrefix</span><span class=o>:</span> <span class=sr>/\/app1|app4/</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 脚本和样式文件路径前缀，多个脚本可以避免重复写同样的前缀
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>resourcePathPrefix</span><span class=o>:</span> <span class=s2>&#34;/static/app1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 是否启用预加载，启动后刷新页面等当前页面的应用渲染完毕后预加载子应用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>preload</span>: <span class=kt>settings.app1.preload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 切换子应用的模式，默认切换会销毁，设置 coexist 后只会隐藏
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>switchMode</span>: <span class=kt>settings.app1.switchMode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 是否串行加载脚本静态资源
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>loadSerial</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 样式前缀
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stylePrefix</span><span class=o>:</span> <span class=s2>&#34;app1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 脚本资源文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>scripts</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;main.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 样式资源文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>styles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;styles.css&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 应用程序打包后的脚本和样式文件替换
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>manifest</span><span class=o>:</span> <span class=s2>&#34;/static/app1/manifest.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 附加数据，主要应用于业务，比如图标，子应用的颜色，显示名等个性化配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>extra</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;应用1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>color</span><span class=o>:</span> <span class=s2>&#34;#ffa415&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>.......</span>
</span></span><span class=line><span class=cl><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>在看 <code>planet.registerApps</code>之前先看一下 <code>GlobalPlanet</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// global-planet.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 浏览器window对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>declare</span> <span class=kr>const</span> <span class=nb>window</span><span class=o>:</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// interface
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>GlobalPlanet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里是一个Map,key是String类型的，Value为应用的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>apps</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>PlanetApplicationRef</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 基座模式，只需要一个Portal
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>portalApplication?</span>: <span class=kt>PlanetPortalApplication</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 应用加载器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>applicationLoader?</span>: <span class=kt>PlanetApplicationLoader</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// service,函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>applicationService?</span>: <span class=kt>PlanetApplicationService</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 全局变量，如果window.planet不为空那么就拿window.planet的值，不然就初始化一个app的map出来
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>globalPlanet</span>: <span class=kt>GlobalPlanet</span> <span class=o>=</span> <span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>planet</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>planet</span> <span class=o>||</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>apps</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 先看一眼，下面会在回来看
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineApplication</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>BootstrapAppModule</span> <span class=o>|</span> <span class=nx>BootstrapOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> application has exist.`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>options</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>template</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>bootstrap</span>: <span class=kt>options</span> <span class=kr>as</span> <span class=nx>BootstrapAppModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>PlanetApplicationRef</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>options</span> <span class=kr>as</span> <span class=nx>BootstrapOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了继续看<code>defineApplication</code>先看一个用例,这个用例是<code>app1</code>的<code>main.ts</code>中的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// app1的 main.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 调用defineApplication 传入
</span></span></span><span class=line><span class=cl><span class=c1>// 1. app1,
</span></span></span><span class=line><span class=cl><span class=c1>// 2.函数返回 ModuleRef 启动的模块
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>defineApplication</span><span class=p>(</span><span class=s1>&#39;app1&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// template 为一个dom字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>template</span><span class=o>:</span> <span class=sb>`&lt;app1-root class=&#34;app1-root&#34;&gt;&lt;/app1-root&gt;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// bootstrap 应用的加载点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bootstrap</span><span class=o>:</span> <span class=p>(</span><span class=nx>portalApp</span>: <span class=kt>PlanetPortalApplication</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// platformBrowserDynamic 传入 Provider, Provider同于 app.module中的providers 提供服务用的，作者在这里插入了两个 值或对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>&gt;&gt;&gt;&gt;</span>  <span class=kr>export</span> <span class=kr>declare</span> <span class=kr>const</span> <span class=nx>platformBrowserDynamic</span><span class=o>:</span> <span class=p>(</span><span class=nx>extraProviders?</span>: <span class=kt>StaticProvider</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>PlatformRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>platformBrowserDynamic</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 其实提供服务也可以理解成有一个Context,把Value注入到Context中了，在项目中的Context中可以通过Inject方式来提取使用这个服务了
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>provide</span>: <span class=kt>PlanetPortalApplication</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 注意这里传入的是 defineApplication 函数 第二参数options中 BootstrapAppModule中的回调参数
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>useValue</span>: <span class=kt>portalApp</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 引导AppModule模块,创建@NgModule实例也就是创建一个AppModule出来
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>.</span><span class=nx>bootstrapModule</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>appModule</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 最后返回Promise&lt;NgModule&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 至此，第二参中的BootstrapAppModule结束
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=nx>appModule</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>error</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>好，现在返回<code>defineApplication</code>中去看看用两个参数做了些什么呢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-applicaiton.ref.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 这是第二参的类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>BootstrapOptions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>template</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>bootstrap</span>: <span class=kt>BootstrapAppModule</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 第二参数中 bootstrap 要传入portalApp然后返回NgModuldeRef
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>type</span> <span class=nx>BootstrapAppModule</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>portalApp?</span>: <span class=kt>PlanetPortalApplication</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>NgModuleRef</span><span class=err>&lt;</span><span class=na>any</span><span class=p>&gt;</span><span class=o>&gt;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>上面已经讲过怎么用了,下面看当调用时，包内发生了什么?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// global-planet.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineApplication</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>BootstrapAppModule</span> <span class=o>|</span> <span class=nx>BootstrapOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 首先，看看globalPlanet的app map中有没有加入过这个项目，也就是说，如果有10个应用，调用defineApplication时传入相同的第一参name,就会发生应用重复，无法分别当前需要加载的是哪个应用，作者在这里判断并抛出异常
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> application has exist.`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 其次，看options第二参数，是带template的Bootstrap函数还是直接就是bootstrap函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>options</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是函数，那么template为空，第二参数转化类型,options备用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>template</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>bootstrap</span>: <span class=kt>options</span> <span class=kr>as</span> <span class=nx>BootstrapAppModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里比较关键了，通过name和options new了一个PlanetApplicationRef对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>PlanetApplicationRef</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>options</span> <span class=kr>as</span> <span class=nx>BootstrapOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将appRef也就是子applicaiton的引用加入globalPlanet.apps的map中，也就是window.planet.apps中,至于为什么，前面有提到
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看看如何 new 一个子应用引用对象吧~</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-ref.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetApplicationRef</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=nx>innerSelector</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 这里 将 innerSelector调用方式改为了 app.selector因为是私有变量嘛
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>public</span> <span class=kr>get</span> <span class=nx>selector() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>innerSelector</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 首先，构造函数两个参数由defineApplication传递过来
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kr>constructor</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>options</span>: <span class=kt>BootstrapOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 传递一些值给当前对象的属性
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>template</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>template</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果template被传入了 getTagNameByTemplate,由于是util不在赘述，这里拿到了标签名称，稍后看一个应用demo
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>innerSelector</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>template</span> <span class=o>?</span> <span class=nx>getTagNameByTemplate</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>template</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将Promise&lt;NgModuleRef&gt;也就是bootstrap Instance也传进来
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>appModuleBootstrap</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>bootstrap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>作者每一个属性名和变量的词语都非常精准，所以导致看代码的时候非常好看,非常干净,这也是 clean code 第一章所追求的,我所追求的代码风格，非常棒</p></blockquote><p>看一个 selecor 应用 demo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 首先通过name获取ApplicationRef引用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>hideApp</span><span class=p>(</span><span class=nx>planetApp</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>planetApp</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取插入的整体dom节点的document,通过selector
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>selector</span> <span class=o>||</span> <span class=nx>planetApp</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 隐藏dom元素
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=s1>&#39;display:none;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>好了，至此注册内容结束，总体来说就是把 name 和 template 放到 window 下的对象中的 map 里，在提供一个 boostrap 和 angular 的 main.ts 结合起来，将 instance 也存入 map 中</p><h1 id=再次回到-portal-的-appcomponent这次看细致一些>再次回到 Portal 的 appcomponent,这次看细致一些<a hidden class=anchor aria-hidden=true href=#再次回到-portal-的-appcomponent这次看细致一些>#</a></h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// portal appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 注册了planet
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kr>private</span> <span class=nx>planet</span>: <span class=kt>Planet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>看看初始化 plant 的时候，plant 内部是什么样子的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet.ts
</span></span></span><span class=line><span class=cl><span class=c1>// injectable -&gt; context
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>providedIn</span><span class=o>:</span> <span class=s1>&#39;root&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Planet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 看这里，当factory向context注入Planet时，发生了什么
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kr>private</span> <span class=nx>injector</span>: <span class=kt>Injector</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kr>private</span> <span class=nx>router</span>: <span class=kt>Router</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// angular 提供InjectToken方式注入值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>@Inject</span><span class=p>(</span><span class=nx>PLANET_APPLICATIONS</span><span class=p>)</span> <span class=kd>@Optional</span><span class=p>()</span> <span class=nx>planetApplications</span>: <span class=kt>PlanetApplication</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 为了解释，插入一段module.ts的代码
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>---</span><span class=nx>NgxPlanetModule</span> : <span class=kt>module.ts</span>
</span></span><span class=line><span class=cl><span class=c1>// 放出NgxPlanetModule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>NgxPlanetModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 引入模块既可以直接引入也可以NgxPlanetModule.forRoot(apps)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// apps为静态的PlanetApplication集合，其实就是appcomponent中register的那个集合
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 标识为PLANET_APPLICATIONS理解成字符串就好了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Inject(PLANET_APPLICATIONS)也就是拿到外部模块引用forRoot函数中传入的结合
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>static</span> <span class=nx>forRoot</span><span class=p>(</span><span class=nx>apps</span>: <span class=kt>PlanetApplication</span><span class=p>[])</span><span class=o>:</span> <span class=nx>ModuleWithProviders</span><span class=p>&lt;</span><span class=nt>NgxPlanetModule</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>ngModule</span>: <span class=kt>NgxPlanetModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>provide</span>: <span class=kt>PLANET_APPLICATIONS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>useValue</span>: <span class=kt>apps</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>---</span>
</span></span><span class=line><span class=cl><span class=c1>// 回到planet.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过injector从context里提取出injectable过的service,注意，全局唯一service
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>planetApplicationService</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 注意，这里service给了谁了,给了global下的applicationService,也就是window下的那个对象,这里可以点setApplicationService去看,前面看过globalPlanet了
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>setApplicationService</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>injector</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>PlanetApplicationService</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果forRoot传入了apps，那么注册
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>planetApplications</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用注册函数
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>registerApps</span><span class=p>(</span><span class=nx>planetApplications</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 由于construct中用injector获得了全局planetApplicationService实例，所以这里直接可以用了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>registerApps</span><span class=p>&lt;</span><span class=nt>TExtra</span><span class=p>&gt;(</span><span class=nx>apps</span>: <span class=kt>PlanetApplication</span><span class=p>&lt;</span><span class=nt>TExtra</span><span class=p>&gt;[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用service的注册，将apps在向下传一层
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>planetApplicationService</span><span class=p>.</span><span class=nx>register</span><span class=p>(</span><span class=nx>apps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看一下 service 中的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application.service.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providedIn</span><span class=o>:</span> <span class=s2>&#34;root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetApplicationService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// PlanetApplication集合
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>apps</span>: <span class=kt>PlanetApplication</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=c1>// PlanetApplication map
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>appsMap</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>PlanetApplication</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>http</span>: <span class=kt>HttpClient</span><span class=p>,</span> <span class=kr>private</span> <span class=nx>assetsLoader</span>: <span class=kt>AssetsLoader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 首先检测 global下的applicationService是不是已经有了，有了就抛异常，因为这里存的是apps列表，所以不能刷新他的引用使它变成新的对象,不然存储的注册application就没有了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>getApplicationService</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;PlanetApplicationService has been injected in the portal, repeated injection is not allowed&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>register</span><span class=p>&lt;</span><span class=nt>TExtra</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=nx>appOrApps</span>: <span class=kt>PlanetApplication</span><span class=p>&lt;</span><span class=nt>TExtra</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>PlanetApplication</span><span class=p>&lt;</span><span class=nt>TExtra</span><span class=p>&gt;[]</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 单个application转数组,多个application直接返回数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>apps</span> <span class=o>=</span> <span class=nx>coerceArray</span><span class=p>(</span><span class=nx>appOrApps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>apps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>app</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 判断是否注册过了application了
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>appsMap</span><span class=p>[</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> has be registered.`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将application加入apps数组和map中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>apps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>appsMap</span><span class=p>[</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至此，模块启动实例(<code>bootstrap</code>|<code>@NgModule</code>)和注册从<code>main.ts</code>,portal 的<code>appcomponent.ts</code>解析完毕
无论是启动实例或是应用列表，都存在了 global 下面，前一种存到了<code>apps</code>下，后一个，存到了<code>applicationService</code>的数组和 map 中</p><h1 id=第三次回到-portal-的-appcomponent>第三次回到 portal 的 appcomponent<a hidden class=anchor aria-hidden=true href=#第三次回到-portal-的-appcomponent>#</a></h1><p>register 下一行，调用了 start</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// appcomponent.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 调用planet的start
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>planet</span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>看看如何写的,这里我加入了一些 console 通过输出的内容分析一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// plant.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>start() {</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>subscription</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>events</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>filter</span><span class=p>(</span><span class=nx>event</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>event</span> <span class=k>instanceof</span> <span class=nx>NavigationEnd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>((</span><span class=nx>event</span>: <span class=kt>NavigationEnd</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>event</span><span class=p>.</span><span class=nx>urlAfterRedirects</span> <span class=o>||</span> <span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>startWith</span><span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>pathname</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=nx>distinctUntilChanged</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>subscribe</span><span class=p>((</span><span class=nx>url</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>planetApplicationLoader</span><span class=p>.</span><span class=nx>reroute</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=nx>url</span>: <span class=kt>url</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以下是输出内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// construct是我在planetApplicationLoader构造函数里加入的console
</span></span><span class=line><span class=cl>// 通过顺序验证了，当factory创建好了planetApplicationLoader后会立即执行构造函数中的内容，所以construct排第一
</span></span><span class=line><span class=cl>construct
</span></span><span class=line><span class=cl>// subscript真正订阅到的路由字符串
</span></span><span class=line><span class=cl>planet.ts:103 /about
</span></span></code></pre></td></tr></table></div></div><p>然后使用<code>planetApplicationLoader.reroute({})</code>去改变了<code>planetApplicationLoader</code>中的<code>private routeChange$ = new Subject&lt;PlanetRouterEvent>();</code></p><p>由于 construct 先运行，所以先来看<code>planetApplicationLoader</code>的构造函数进行了什么操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>     <span class=c1>// assetsLoader先不考虑，我猜大概是对应了angular静态资源目录进行操作的一个对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>assetsLoader</span>: <span class=kt>AssetsLoader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// planetApplicationService 前面看到的service
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 里面有register和app列表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>planetApplicationService</span>: <span class=kt>PlanetApplicationService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ngZone https://hijiangtao.github.io/2020/01/17/Angular-Zone-Concepts/ 可以看这篇帖子，主要是关于变更检测机制的一个东西
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 简单来说 run runOutsideAngular两个函数，一个是进行变更检测，一个在zone之外运行不触发变更检测
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>ngZone</span>: <span class=kt>NgZone</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 路由
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>router</span>: <span class=kt>Router</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// injector
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>injector</span>: <span class=kt>Injector</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 对页面上运行的angular应用程序的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>applicationRef</span>: <span class=kt>ApplicationRef</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里类似planetApplicationService的检测,检测global中是否已经存在了loader加载器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 那么ApplicationLoader什么时候被创建的呢，看看之前planetApplicationService在哪里创建的，它上面就是setApplicationLoader
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>getApplicationLoader</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;PlanetApplicationLoader has been injected in the portal, repeated injection is not allowed&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置一些参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 应用是隐藏还是销毁
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>switchMode</span>: <span class=kt>SwitchModes.default</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 错误处理回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>errorHandler</span><span class=o>:</span> <span class=p>(</span><span class=nx>error</span>: <span class=kt>Error</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将zone传递给portalApp
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>.</span><span class=nx>ngZone</span> <span class=o>=</span> <span class=nx>ngZone</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当前application的引用传递给portalApp
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>.</span><span class=nx>applicationRef</span> <span class=o>=</span> <span class=nx>applicationRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 路由传递
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>.</span><span class=nx>router</span> <span class=o>=</span> <span class=nx>router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里我理解为把注入器传过来了，也就可以用injector来拿当前context的对象了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 可能理解有误，请在下方留言告知
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>.</span><span class=nx>injector</span> <span class=o>=</span> <span class=nx>injector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 一会儿在看如何共享事件调用的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>.</span><span class=nx>globalEventDispatcher</span> <span class=o>=</span> <span class=nx>injector</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>GlobalEventDispatcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将portalApp给global对象了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>portalApplication</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用了一个关于路由的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>setupRouteChange</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>先看 this.portalApp 是什么</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>//  planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>portalApp</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>PlanetPortalApplication</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>new 了一个 portalApplication 对象对吧，这就是我们的基座 application 了，看看里面有什么</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// portal-application.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetPortalApplication</span><span class=p>&lt;</span><span class=nt>TData</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 当前应用的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>applicationRef</span>: <span class=kt>ApplicationRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注入器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>injector</span>: <span class=kt>Injector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 路由
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>router</span>: <span class=kt>Router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 变更检测
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>ngZone</span>: <span class=kt>NgZone</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 事件分发器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>globalEventDispatcher</span>: <span class=kt>GlobalEventDispatcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 额外数据?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>data</span>: <span class=kt>TData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 跳转函数,返回了一个Promise&lt;boolean&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>navigateByUrl</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nx>UrlTree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>extras?</span>: <span class=kt>NavigationExtras</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>run</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>navigateByUrl</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>extras</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ngZone.run 在变更检测区域内运行函数，这里不知道为何不 object.ngZone.run而是要写一个函数来包装
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>run</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span><span class=nx>fn</span><span class=o>:</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>any</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=nx>T</span><span class=p>)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>run</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 全局性调用变化检测
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// applicationRef可以通过attachView()将视图包含到变化检测中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 可以用detachView()将视图移除变化检测
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>tick() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>applicationRef</span><span class=p>.</span><span class=nx>tick</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>好了，接下来看加载应用的核心函数<code>setupRouteChange</code>这个函数有点长</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl> <span class=kr>private</span> <span class=nx>setupRouteChange() {</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当路由变化时，先思考，application-loader比start调用先创建，所以start后，页面定到/about路由，所以这里可以接收到/about
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>routeChange$</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>distinctUntilChanged</span><span class=p>((</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>(</span><span class=nx>x</span> <span class=o>&amp;&amp;</span> <span class=nx>x</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=o>===</span> <span class=p>(</span><span class=nx>y</span> <span class=o>&amp;&amp;</span> <span class=nx>y</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 和其他打平操作符的主要区别是它具有取消效果。在每次发出时，会取消前一个内部 observable (你所提供函数的结果) 的订阅，然后订阅一个新的 observable
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>switchMap</span><span class=p>(</span><span class=nx>event</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>event</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 卸载应用程序并返回应加载的应用程序
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 这里拿到{url:&#39;/about&#39;}
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>this</span><span class=p>.</span><span class=nx>startRouteChangeEvent</span> <span class=o>=</span> <span class=nx>event</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 通过url找app ,PlanetApplication类型,用service中的app列表和 注册过的app的routerPathPrefix和url进行匹配
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=kr>const</span> <span class=nx>shouldLoadApps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>planetApplicationService</span><span class=p>.</span><span class=nx>getAppsByMatchedUrl</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 这里拿到了需要卸载的应用,下面有讲
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=kr>const</span> <span class=nx>shouldUnloadApps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getUnloadApps</span><span class=p>(</span><span class=nx>shouldLoadApps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 设置加载和卸载的application,这里传入了加载应用和卸卸载应用，并且放出了ob对象，估计是作者提供hook函数，想提供给我们在loading时做一些操作的自定义函数的hook
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// 使用的时候 planet.appsLoadingStart.subscribe就可以拿到了
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>this</span><span class=p>.</span><span class=nx>appsLoadingStart$</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                                <span class=nx>shouldLoadApps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=nx>shouldUnloadApps</span>
</span></span><span class=line><span class=cl>                            <span class=p>});</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 卸载,下面有讲
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>this</span><span class=p>.</span><span class=nx>unloadApps</span><span class=p>(</span><span class=nx>shouldUnloadApps</span><span class=p>,</span> <span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=nx>shouldLoadApps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}),</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 加载静态资源
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>switchMap</span><span class=p>(</span><span class=nx>shouldLoadApps</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=kd>let</span> <span class=nx>hasAppsNeedLoadingAssets</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=kr>const</span> <span class=nx>loadApps$</span> <span class=o>=</span> <span class=nx>shouldLoadApps</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 获取当前app的状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=kr>const</span> <span class=nx>appStatus</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>appsStatus</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>//  如果没有加载过，或者曾经加载错了
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=c1>// 设置需要加载状态后使用assetsLoader去加载静态资源,稍后讲assetsLoader
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                                    <span class=o>!</span><span class=nx>appStatus</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoading</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>loadError</span>
</span></span><span class=line><span class=cl>                                <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>hasAppsNeedLoadingAssets</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>runOutsideAngular</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>startLoadAppAssets</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                    <span class=p>});</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>});</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>hasAppsNeedLoadingAssets</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>this</span><span class=p>.</span><span class=nx>loadingDone</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=nx>loadApps$</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=nx>forkJoin</span><span class=p>(</span><span class=nx>loadApps$</span><span class=p>)</span> <span class=o>:</span> <span class=k>of</span><span class=p>([]</span> <span class=kr>as</span> <span class=nx>PlanetApplication</span><span class=p>[]);</span>
</span></span><span class=line><span class=cl>                        <span class=p>}),</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 引导启动或展示application
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>map</span><span class=p>(</span><span class=nx>apps</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=kr>const</span> <span class=nx>apps$</span>: <span class=kt>Observable</span><span class=p>&lt;</span><span class=nt>PlanetApplication</span><span class=p>&gt;[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>                            <span class=nx>apps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 获取app状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=kr>const</span> <span class=nx>appStatus</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>appsStatus</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 如果引导过了,也就是拿到过context了
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapped</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>apps$</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                        <span class=k>of</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                            <span class=nx>tap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 展示app
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>this</span><span class=p>.</span><span class=nx>showApp</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 获取app引用
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 路由跳转 router是从 applicationRef也就是子application中 inject出来的router,所以路由表完备
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=nx>appRef</span><span class=p>.</span><span class=nx>navigateByUrl</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 设置app状态为激活状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>active</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 加载结束
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>this</span><span class=p>.</span><span class=nx>setLoadingDone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                                            <span class=p>})</span>
</span></span><span class=line><span class=cl>                                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoaded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// 如果appStatus状态为静态资源加载完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=nx>apps$</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                        <span class=k>of</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                            <span class=nx>switchMap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 引导app获取app context中的一些对象
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>bootstrapApp</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                                    <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                        <span class=c1>// 设置app模式为激活状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                        <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>active</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                        <span class=c1>// 加载完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                        <span class=k>this</span><span class=p>.</span><span class=nx>setLoadingDone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                                                        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                    <span class=p>})</span>
</span></span><span class=line><span class=cl>                                                <span class=p>);</span>
</span></span><span class=line><span class=cl>                                            <span class=p>})</span>
</span></span><span class=line><span class=cl>                                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// 如果应用未激活状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>apps$</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                        <span class=k>of</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                            <span class=nx>tap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 获取引用
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 获取当前路径
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=kr>const</span> <span class=nx>currentUrl</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>getCurrentRouterStateUrl</span><span class=o>?</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>getCurrentRouterStateUrl</span><span class=p>()</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 如果当前url和 事件url不一致
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>if</span> <span class=p>(</span><span class=nx>currentUrl</span> <span class=o>!==</span> <span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                    <span class=c1>// 路由跳转
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                    <span class=nx>appRef</span><span class=p>.</span><span class=nx>navigateByUrl</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                                            <span class=p>})</span>
</span></span><span class=line><span class=cl>                                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                        <span class=sb>`app(</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>)&#39;s status is </span><span class=si>${</span><span class=nx>appStatus</span><span class=si>}</span><span class=sb>, can&#39;t be show or bootstrap`</span>
</span></span><span class=line><span class=cl>                                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>apps$</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 切换到应用后会有闪烁现象，所以使用 setTimeout 后启动应用
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=c1>// 此处判断是因为如果静态资源加载完毕还未启动被取消，还是会启动之前的应用，虽然可能性比较小，但是无法排除这种可能性，所以只有当 Event 是最后一个才会启动
</span></span></span><span class=line><span class=cl><span class=c1></span>                                    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>startRouteChangeEvent</span> <span class=o>===</span> <span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                        <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>runOutsideAngular</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                            <span class=c1>// 将apps中的ob们合并到一起执行后
</span></span></span><span class=line><span class=cl><span class=c1></span>                                            <span class=nx>forkJoin</span><span class=p>(</span><span class=nx>apps$</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 设置加载完成状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>this</span><span class=p>.</span><span class=nx>setLoadingDone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                                                <span class=c1>// 然后去搞预加载,注册时传入的参数preload=tue/false
</span></span></span><span class=line><span class=cl><span class=c1></span>                                                <span class=k>this</span><span class=p>.</span><span class=nx>ensurePreloadApps</span><span class=p>(</span><span class=nx>apps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                            <span class=p>});</span>
</span></span><span class=line><span class=cl>                                        <span class=p>});</span>
</span></span><span class=line><span class=cl>                                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                                <span class=p>});</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// 设置
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>this</span><span class=p>.</span><span class=nx>ensurePreloadApps</span><span class=p>(</span><span class=nx>apps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                                <span class=k>this</span><span class=p>.</span><span class=nx>setLoadingDone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}),</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 使用自定义异常hook function
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>catchError</span><span class=p>(</span><span class=nx>error</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>this</span><span class=p>.</span><span class=nx>errorHandler</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>                        <span class=p>})</span>
</span></span><span class=line><span class=cl>                    <span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=nx>subscribe</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后看<code>unload</code>,<code>bootstrap</code>,<code>destory</code>,<code>preload</code>,<code>show</code>,<code>hide</code>,卸载，加载，销毁，预加载，展示，隐藏相关的这几个函数</p><p>获取卸载 app</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-applicaiton-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 传入激活的application列表
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kr>private</span> <span class=nx>getUnloadApps</span><span class=p>(</span><span class=nx>activeApps</span>: <span class=kt>PlanetApplication</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>unloadApps</span>: <span class=kt>PlanetApplication</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>appsStatus</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>value</span><span class=p>,</span> <span class=nx>app</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// application状态为激活，但是激活列表中没有这个application
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nx>value</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>active</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>activeApps</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>item</span> <span class=o>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 那么放入待卸载应用集合里
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>unloadApps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>unloadApps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>卸载</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-applicaiton-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 卸载applications,第一参为application集合,第二个参数类似{url:&#39;/about&#39;}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>private</span> <span class=nx>unloadApps</span><span class=p>(</span><span class=nx>shouldUnloadApps</span>: <span class=kt>PlanetApplication</span><span class=p>[],</span> <span class=nx>event</span>: <span class=kt>PlanetRouterEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>hideApps</span>: <span class=kt>PlanetApplication</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>destroyApps</span>: <span class=kt>PlanetApplication</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 需要卸载的app看看是隐藏模式还是销毁模式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>shouldUnloadApps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// app.SwitchMode参数的两个值，在注册的时候设置的
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// coexist模式
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>switchModeIsCoexist</span><span class=p>(</span><span class=nx>app</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>hideApps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 隐藏应用
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>hideApp</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 设置状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapped</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// default模式,销毁模式
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>destroyApps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 销毁之前先隐藏，否则会出现闪烁，因为 destroy 是延迟执行的
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 如果销毁不延迟执行，会出现切换到主应用的时候会有视图卡顿现象
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>hideApp</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>---</span>
</span></span><span class=line><span class=cl>    <span class=c1>// application应用状态有5个
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 资源加载状态分别是,我估计这里和预加载或者做判断有用到
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&gt;&gt;</span>  <span class=nx>assetsLoading</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 资源被加载状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>assetsLoaded</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 正在引导启动状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bootstrapping</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 已经被引导启动状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bootstrapped</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 激活状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>active</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 加载失败
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>loadError</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>    <span class=o>---</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoaded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果隐藏列表或销毁列表中有值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>hideApps</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>destroyApps</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 从其他应用切换到主应用的时候会有视图卡顿现象，所以先等主应用渲染完毕后再加载其他应用
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 此处尝试使用 this.ngZone.onStable.pipe(take(1)) 应用之间的切换会出现闪烁
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 这里还不太理解
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>hideApps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>appRef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRef</span><span class=p>.</span><span class=nx>navigateByUrl</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 销毁app
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>destroyApps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>destroyApp</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>销毁</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 传入需要销毁的application
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kr>private</span> <span class=nx>destroyApp</span><span class=p>(</span><span class=nx>planetApp</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=c1>// 得到applicationRef的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>planetApp</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 销毁
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>appRef</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 删除 document节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nx>getHTMLElement</span><span class=p>(</span><span class=nx>planetApp</span><span class=p>.</span><span class=nx>hostParent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nx>container</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>((</span><span class=nx>appRef</span> <span class=o>&amp;&amp;</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>selector</span><span class=p>)</span> <span class=o>||</span> <span class=nx>planetApp</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>.</span><span class=nx>removeChild</span><span class=p>(</span><span class=nx>appRootElement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>显示和隐藏</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>hideApp</span><span class=p>(</span><span class=nx>planetApp</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>planetApp</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拿到dom节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>selector</span> <span class=o>||</span> <span class=nx>planetApp</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// css隐藏
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=s1>&#39;display:none;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>showApp</span><span class=p>(</span><span class=nx>planetApp</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>planetApp</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拿到dom节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>selector</span> <span class=o>||</span> <span class=nx>planetApp</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 去除隐藏样式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>预加载</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-applicatin-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kr>private</span> <span class=nx>ensurePreloadApps</span><span class=p>(</span><span class=nx>activeApps?</span>: <span class=kt>PlanetApplication</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 第一次加载的时候 对app进行预加载
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>firstLoad</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>preloadApps</span><span class=p>(</span><span class=nx>activeApps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>firstLoad</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>private</span> <span class=nx>preloadApps</span><span class=p>(</span><span class=nx>activeApps?</span>: <span class=kt>PlanetApplication</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 过滤preload为true的application
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>toPreloadApps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>planetApplicationService</span><span class=p>.</span><span class=nx>getAppsToPreload</span><span class=p>(</span><span class=nx>activeApps</span> <span class=o>?</span> <span class=nx>activeApps</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=o>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 加载
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>loadApps$</span> <span class=o>=</span> <span class=nx>toPreloadApps</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>preloadApp</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>preloadInternal</span><span class=p>(</span><span class=nx>preloadApp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 对加载过程使用hooks错误处理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>forkJoin</span><span class=p>(</span><span class=nx>loadApps$</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>error</span>: <span class=kt>error</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>errorHandler</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 第一参数application,第二参是否直接加载
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>private</span> <span class=nx>preloadInternal</span><span class=p>(</span><span class=nx>app</span>: <span class=kt>PlanetApplication</span><span class=p>,</span> <span class=nx>immediate?</span>: <span class=kt>boolean</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>PlanetApplicationRef</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取app状态
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>status</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>appsStatus</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果没有状态或者加载错误
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>status</span> <span class=o>||</span> <span class=nx>status</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>loadError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>startLoadAppAssets</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>switchMap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 如果是直接加载
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=nx>immediate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 在隐藏模式下加载
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>bootstrapApp</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=s1>&#39;hidden&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 如果不是直接加载
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 在状态监测之外
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>runOutsideAngular</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// 加载applicaiton
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>bootstrapApp</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=s1>&#39;hidden&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 返回application的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果在application属于其他状态
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoading</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoaded</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapping</span><span class=p>].</span><span class=nx>includes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>status</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>appStatusChange</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>filter</span><span class=p>(</span><span class=nx>event</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>event</span><span class=p>.</span><span class=nx>app</span> <span class=o>===</span> <span class=nx>app</span> <span class=o>&amp;&amp;</span> <span class=nx>event</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapped</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>take</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 返回引用
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 异常
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>appRef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>&#39;s status is </span><span class=si>${</span><span class=nx>ApplicationStatus</span><span class=p>[</span><span class=nx>status</span><span class=p>]</span><span class=si>}</span><span class=sb>, planetApplicationRef is null.`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>appRef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>bootstrap</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=kr>private</span> <span class=nx>bootstrapApp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>app</span>: <span class=kt>PlanetApplication</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>defaultStatus</span><span class=o>:</span> <span class=s1>&#39;hidden&#39;</span> <span class=o>|</span> <span class=s1>&#39;display&#39;</span> <span class=o>=</span> <span class=s1>&#39;display&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>PlanetApplicationRef</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置状态正在加载中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapping</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取app的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=nx>getPlanetApplicationRef</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果注册了且boostrap函数不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>appRef</span> <span class=o>&amp;&amp;</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>bootstrap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取 宿主dom
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nx>getHTMLElement</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>hostParent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nx>appRootElement</span>: <span class=kt>HTMLElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 进行显示隐藏，加入前缀，宿主class的操作
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nx>container</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nx>container</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>selector</span> <span class=o>||</span> <span class=nx>app</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nx>createElementByTemplate</span><span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRootElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>selector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=s1>&#39;display:none;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>hostClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(...</span><span class=nx>coerceArray</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>hostClass</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>stylePrefix</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(...</span><span class=nx>coerceArray</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>stylePrefix</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>container</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>appRootElement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 加载
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kd>let</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>bootstrap</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>[</span><span class=s1>&#39;then&#39;</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>result</span> <span class=o>=</span> <span class=kr>from</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>PlanetApplicationRef</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 最后返回app引用
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=nx>result</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>tap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>bootstrapped</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>defaultStatus</span> <span class=o>===</span> <span class=s1>&#39;display&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>appRootElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>appRootElement</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=s1>&#39;style&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>appRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sb>`[</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>] not found, make sure that the app has the correct name defined use defineApplication(</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>) and runtimeChunk and vendorChunk are set to true, details see https://github.com/worktile/ngx-planet#throw-error-cannot-read-property-call-of-undefined-at-__webpack_require__-bootstrap79`</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>app.Ref.bootstrap()</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-ref
</span></span></span><span class=line><span class=cl><span class=c1>// 加载应用获取application的引用后返回自身  PlanetApplicationRef类型
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>bootstrap</span><span class=p>(</span><span class=nx>app</span>: <span class=kt>PlanetPortalApplication</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>this</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>appModuleBootstrap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`app(</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>) is not defined`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>portalApp</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 使用main.ts中传入的bootstrap来加载app,然后拿到模块引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kr>from</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>appModuleBootstrap</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>appModuleRef</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 传递引用,然后复制一些自己想要的信息从appModuleRef中
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>appModuleRef</span> <span class=o>=</span> <span class=nx>appModuleRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 传递name
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>appModuleRef</span><span class=p>.</span><span class=nx>instance</span><span class=p>.</span><span class=nx>appName</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=p>.</span><span class=nx>syncPortalRouteWhenNavigationEnd</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 返回
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>this.appModuleBootstrap</code>是通过<code>main.ts</code>的<code>defineApplication</code>第二参数的<code>bootstrap</code>传入的,之前看过一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// global-planet.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineApplication</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>BootstrapAppModule</span> <span class=o>|</span> <span class=nx>BootstrapOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> application has exist.`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>options</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>template</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>bootstrap</span>: <span class=kt>options</span> <span class=kr>as</span> <span class=nx>BootstrapAppModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里new了一个PlanetApplicationRef然后将引用传入了map中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>PlanetApplicationRef</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>options</span> <span class=kr>as</span> <span class=nx>BootstrapOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>this.appModuleBootstrap</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-ref.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetApplicationRef</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里是global-planet new的对象时候传入的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>appModuleBootstrap</span><span class=o>:</span> <span class=p>(</span><span class=nx>app</span>: <span class=kt>PlanetPortalApplication</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>NgModuleRef</span><span class=err>&lt;</span><span class=na>any</span><span class=p>&gt;</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=kr>constructor</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>options</span>: <span class=kt>BootstrapOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>template</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>template</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>innerSelector</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>template</span> <span class=o>?</span> <span class=nx>getTagNameByTemplate</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>template</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 具体传入
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>appModuleBootstrap</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>bootstrap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至此，bootstrap 结束</p><h1 id=assetsloader>assetsLoader<a hidden class=anchor aria-hidden=true href=#assetsloader>#</a></h1><p>之前在核心的<code>setupRouteChange</code>走第三步之前，中间有一个加载 assets 的阶段，毕竟子应用的<code>main.ts</code>应该是不能主动注册过来的,需要加载静态文件来获取，我是这么猜测的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-application-loader.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>switchMap</span><span class=p>((</span><span class=nx>shouldLoadApps</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>hasAppsNeedLoadingAssets</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>loadApps$</span> <span class=o>=</span> <span class=nx>shouldLoadApps</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>app</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>appStatus</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>appsStatus</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>appStatus</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoading</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>appStatus</span> <span class=o>===</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>loadError</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hasAppsNeedLoadingAssets</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>runOutsideAngular</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 核心调用,开始加载application的assets
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>startLoadAppAssets</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasAppsNeedLoadingAssets</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>loadingDone</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>loadApps$</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>forkJoin</span><span class=p>(</span><span class=nx>loadApps$</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=k>of</span><span class=p>([]</span> <span class=kr>as</span> <span class=nx>PlanetApplication</span><span class=p>[]);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=kr>private</span> <span class=nx>startLoadAppAssets</span><span class=p>(</span><span class=nx>app</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>inProgressAppAssetsLoads</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>inProgressAppAssetsLoads</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// assetsLoader.loadAppAssets 核心函数,调用完毕后看是否放入map中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>loadApp$</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>assetsLoader</span><span class=p>.</span><span class=nx>loadAppAssets</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>tap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>inProgressAppAssetsLoads</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 设置加载完毕状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoaded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>catchError</span><span class=p>(</span><span class=nx>error</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>inProgressAppAssetsLoads</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 加载失败状态
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>loadError</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=nx>share</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 放入map中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>inProgressAppAssetsLoads</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>loadApp$</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 设置状态为assetsLoading状态,这里要知道返回的ob所以写代码的时候Loaded在Loading上面，真正订阅subscribe的时候，顺序就对了
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>setAppStatus</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=nx>ApplicationStatus</span><span class=p>.</span><span class=nx>assetsLoading</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>loadApp$</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>调用了构造器注入的 <code>assetsLoader</code> 看一眼 loader 里咋写的吧</p><p>关于 mainfest.json 看一看 <a href=https://jonny-huang.github.io/angular/training/19_pwa/>https://jonny-huang.github.io/angular/training/19_pwa/</a> 有关于 PWA 方面的内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;main.js&#34;</span><span class=p>:</span> <span class=s2>&#34;main-es2015.js&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;main.js.map&#34;</span><span class=p>:</span> <span class=s2>&#34;main-es2015.js.map&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;polyfills-es5.js&#34;</span><span class=p>:</span> <span class=s2>&#34;polyfills-es5-es2015.js&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;polyfills-es5.js.map&#34;</span><span class=p>:</span> <span class=s2>&#34;polyfills-es5-es2015.js.map&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;polyfills.js&#34;</span><span class=p>:</span> <span class=s2>&#34;polyfills-es2015.js&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;polyfills.js.map&#34;</span><span class=p>:</span> <span class=s2>&#34;polyfills-es2015.js.map&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;styles.css&#34;</span><span class=p>:</span> <span class=s2>&#34;styles.css&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;styles.css.map&#34;</span><span class=p>:</span> <span class=s2>&#34;styles.css.map&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// load结果的接口类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>AssetsLoadResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>src</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>hashCode</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>loaded</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// context注入,全剧唯一
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providedIn</span><span class=o>:</span> <span class=s2>&#34;root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AssetsLoader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载过的sources
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>loadedSources</span>: <span class=kt>number</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取http客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>http</span>: <span class=kt>HttpClient</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载script
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadScript</span><span class=p>(</span><span class=nx>src</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// hashCode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>hashCode</span><span class=p>(</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过hashCode判断是否加载过了这个js
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>loadedSources</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>of</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 然后构建&lt;script type=&#34;text/javascript&#34; src=&#34;&#34;&gt; 插入dom
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=nx>Observable</span><span class=p>((</span><span class=nx>observer</span>: <span class=kt>Observer</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=p>&gt;)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>script</span>: <span class=kt>HTMLScriptElement</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;script&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>script</span><span class=p>.</span><span class=kr>type</span> <span class=o>=</span> <span class=s2>&#34;text/javascript&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>script</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>script</span><span class=p>.</span><span class=kr>async</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>script</span><span class=p>[</span><span class=s2>&#34;readyState&#34;</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// IE
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>script</span><span class=p>[</span><span class=s2>&#34;onreadystatechange&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>script</span><span class=p>[</span><span class=s2>&#34;readyState&#34;</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;loaded&#34;</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>            <span class=nx>script</span><span class=p>[</span><span class=s2>&#34;readyState&#34;</span><span class=p>]</span> <span class=o>===</span> <span class=s2>&#34;complete&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>script</span><span class=p>[</span><span class=s2>&#34;onreadystatechange&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>observer</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=nx>observer</span><span class=p>.</span><span class=nx>complete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>loadedSources</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Others
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>script</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>observer</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=nx>observer</span><span class=p>.</span><span class=nx>complete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>loadedSources</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>script</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>loaded</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>error</span>: <span class=kt>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>complete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载style  和script一个道理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadStyle</span><span class=p>(</span><span class=nx>src</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>hashCode</span><span class=p>(</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>loadedSources</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>of</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>Observable</span><span class=p>((</span><span class=nx>observer</span>: <span class=kt>Observer</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=p>&gt;)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>head</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementsByTagName</span><span class=p>(</span><span class=s2>&#34;head&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>link</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;link&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=nx>rel</span> <span class=o>=</span> <span class=s2>&#34;stylesheet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=kr>type</span> <span class=o>=</span> <span class=s2>&#34;text/css&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=nx>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=nx>media</span> <span class=o>=</span> <span class=s2>&#34;all&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>complete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>loadedSources</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>link</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>src</span>: <span class=kt>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>hashCode</span>: <span class=kt>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>status</span><span class=o>:</span> <span class=s2>&#34;Loaded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>error</span>: <span class=kt>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=nx>observer</span><span class=p>.</span><span class=nx>complete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>link</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载script集合
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadScripts</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>sources</span>: <span class=kt>string</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>serial</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isEmpty</span><span class=p>(</span><span class=nx>sources</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>observables</span> <span class=o>=</span> <span class=nx>sources</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>src</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadScript</span><span class=p>(</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>serial</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>concat</span><span class=p>(...</span><span class=nx>observables</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>map</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=k>of</span><span class=p>([</span><span class=nx>item</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>concatAll</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>forkJoin</span><span class=p>(</span><span class=nx>observables</span><span class=p>).</span><span class=nx>pipe</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载style集合
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadStyles</span><span class=p>(</span><span class=nx>sources</span>: <span class=kt>string</span><span class=p>[])</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>AssetsLoadResult</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isEmpty</span><span class=p>(</span><span class=nx>sources</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>forkJoin</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>sources</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>src</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadStyle</span><span class=p>(</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 双重加载
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadScriptsAndStyles</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>scripts</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>styles</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>serial</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>forkJoin</span><span class=p>([</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>loadScripts</span><span class=p>(</span><span class=nx>scripts</span><span class=p>,</span> <span class=nx>serial</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>loadStyles</span><span class=p>(</span><span class=nx>styles</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载static资源
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadAppAssets</span><span class=p>(</span><span class=nx>app</span>: <span class=kt>PlanetApplication</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=nx>manifest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通过httpClient找到json，通过json找到script路径，最后插入到dom中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadManifest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span><span class=si>${</span><span class=nx>app</span><span class=p>.</span><span class=nx>manifest</span><span class=si>}</span><span class=sb>?t=</span><span class=si>${</span><span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>getTime</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>switchMap</span><span class=p>((</span><span class=nx>manifestResult</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 获取了css和js的全路径 app1/{json中的js和css}
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=p>{</span> <span class=nx>scripts</span><span class=p>,</span> <span class=nx>styles</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getScriptsAndStylesFullPaths</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>app</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>manifestResult</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 然后加载
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadScriptsAndStyles</span><span class=p>(</span><span class=nx>scripts</span><span class=p>,</span> <span class=nx>styles</span><span class=p>,</span> <span class=nx>app</span><span class=p>.</span><span class=nx>loadSerial</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>scripts</span><span class=p>,</span> <span class=nx>styles</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getScriptsAndStylesFullPaths</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>loadScriptsAndStyles</span><span class=p>(</span><span class=nx>scripts</span><span class=p>,</span> <span class=nx>styles</span><span class=p>,</span> <span class=nx>app</span><span class=p>.</span><span class=nx>loadSerial</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加载mainfest
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>loadManifest</span><span class=p>(</span><span class=nx>url</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=o>&lt;</span><span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=kt>string</span> <span class=p>}</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>url</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>map</span><span class=p>((</span><span class=nx>response</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>到此，javascript 和 stylesheet 加载完毕</p><h1 id=组件注册>组件注册<a hidden class=anchor aria-hidden=true href=#组件注册>#</a></h1><p>直接看文件然后找个例子看看</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-component-ref.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 引用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetComponentRef</span><span class=p>&lt;</span><span class=nt>TComp</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 包装元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>wrapperElement</span>: <span class=kt>HTMLElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 组件类型
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>componentInstance</span>: <span class=kt>TComp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 组件引用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>componentRef</span>: <span class=kt>ComponentRef</span><span class=p>&lt;</span><span class=nt>TComp</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 处理函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dispose</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// planet-component-config.ts
</span></span></span><span class=line><span class=cl><span class=c1>// 组件配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlantComponentConfig</span><span class=p>&lt;</span><span class=nt>TData</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 目标容器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>container</span>: <span class=kt>HTMLElement</span> <span class=o>|</span> <span class=nx>ElementRef</span><span class=p>&lt;</span><span class=nt>HTMLElement</span> <span class=err>|</span> <span class=na>any</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 包装class
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>wrapperClass?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 初始化状态
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>initialState?</span>: <span class=kt>TData</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>componentWrapperClass</span> <span class=o>=</span> <span class=s1>&#39;planet-component-wrapper&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>PlanetComponent</span><span class=p>&lt;</span><span class=nt>T</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>component</span>: <span class=kt>ComponentType</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>providedIn</span><span class=o>:</span> <span class=s1>&#39;root&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PlanetComponentLoader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>domPortalOutletCache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>&lt;</span><span class=nt>any</span><span class=err>,</span> <span class=na>DomPortalOutlet</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>get</span> <span class=nx>applicationLoader() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>getApplicationLoader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>get</span> <span class=nx>applicationService() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>getApplicationService</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当前页面应用的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>applicationRef</span>: <span class=kt>ApplicationRef</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 模块的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>ngModuleRef</span>: <span class=kt>NgModuleRef</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 变更检测
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>private</span> <span class=nx>ngZone</span>: <span class=kt>NgZone</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// document
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>@Inject</span><span class=p>(</span><span class=nx>DOCUMENT</span><span class=p>)</span> <span class=kr>private</span> <span class=nb>document</span><span class=o>:</span> <span class=kt>any</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取Planet存储的Application的引用，通过name,返回一个ob&lt;引用&gt;对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>getPlantAppRef</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>PlanetApplicationRef</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>].</span><span class=nx>appModuleRef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>applicationService</span><span class=p>.</span><span class=nx>getAppByName</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>applicationLoader</span><span class=p>.</span><span class=nx>preload</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=nx>globalPlanet</span><span class=p>.</span><span class=nx>apps</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 传入模块和组件的引用,创建injector
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>createInjector</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>        <span class=nx>appModuleRef</span>: <span class=kt>NgModuleRef</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>        <span class=nx>componentRef</span>: <span class=kt>PlanetComponentRef</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>:</span> <span class=nx>PortalInjector</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>injectionTokens</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>&lt;</span><span class=nt>any</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;([[</span><span class=nx>PlanetComponentRef</span><span class=p>,</span> <span class=nx>componentRef</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>defaultInjector</span> <span class=o>=</span> <span class=nx>appModuleRef</span><span class=p>.</span><span class=nx>injector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=nx>PortalInjector</span><span class=p>(</span><span class=nx>defaultInjector</span><span class=p>,</span> <span class=nx>injectionTokens</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取container内component的HTML元素
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>getContainerElement</span><span class=p>(</span><span class=nx>config</span>: <span class=kt>PlantComponentConfig</span><span class=p>)</span><span class=o>:</span> <span class=nx>HTMLElement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>config</span><span class=p>.</span><span class=nx>container</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`config &#39;container&#39; cannot be null`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=nx>config</span><span class=p>.</span><span class=nx>container</span> <span class=kr>as</span> <span class=nx>ElementRef</span><span class=p>).</span><span class=nx>nativeElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>container</span> <span class=kr>as</span> <span class=nx>ElementRef</span><span class=p>).</span><span class=nx>nativeElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>config</span><span class=p>.</span><span class=nx>container</span> <span class=kr>as</span> <span class=nx>HTMLElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建包装元素
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>createWrapperElement</span><span class=p>(</span><span class=nx>config</span>: <span class=kt>PlantComponentConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getContainerElement</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建div
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>element</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拿到应用PlantApplication
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>subApp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>applicationService</span><span class=p>.</span><span class=nx>getAppByName</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>ngModuleRef</span><span class=p>.</span><span class=nx>instance</span><span class=p>.</span><span class=nx>appName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 加入 planet-component-wrapper 在classList中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>element</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>componentWrapperClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 加入 attribute planet-inline
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>element</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;planet-inline&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果设置中配置了wrapperClass
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>wrapperClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 加入
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>element</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>wrapperClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果注册的时候加入了stylePrefix前缀
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>subApp</span> <span class=o>&amp;&amp;</span> <span class=nx>subApp</span><span class=p>.</span><span class=nx>stylePrefix</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 加入到classList里
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>element</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>subApp</span><span class=p>.</span><span class=nx>stylePrefix</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// container插入element
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>container</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>element</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>element</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 附加组件在页面上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>private</span> <span class=nx>attachComponent</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>        <span class=nx>plantComponent</span>: <span class=kt>PlanetComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>appModuleRef</span>: <span class=kt>NgModuleRef</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span>: <span class=kt>PlantComponentConfig</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>:</span> <span class=nx>PlanetComponentRef</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建一个planetComponent引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 注意里面有实例 componentInstance: TComp;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 有引用 componentRef: ComponentRef&lt;TComp&gt;;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>plantComponentRef</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>PlanetComponentRef</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 组件工厂解析器, 组件工厂解析器可以产生一个组件工厂(ComponentFactory)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>componentFactoryResolver</span> <span class=o>=</span> <span class=nx>appModuleRef</span><span class=p>.</span><span class=nx>componentFactoryResolver</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>appRef</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>applicationRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建一个自定义注入器,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 向入口组件提供自定义注入token时要使用的自定义注入器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>injector</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>createInjector</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;(</span><span class=nx>appModuleRef</span><span class=p>,</span> <span class=nx>plantComponentRef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建包装后的element
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>wrapper</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>createWrapperElement</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果有了相同的dom出口
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=nx>portalOutlet</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>domPortalOutletCache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>wrapper</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>portalOutlet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 那么卸载
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>portalOutlet</span><span class=p>.</span><span class=nx>detach</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// DomPortalOutlet 我理解成，容器？出口？站位dom元素。不知道对不对
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 传递了element,组件工厂,模块引用,注入器
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>portalOutlet</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DomPortalOutlet</span><span class=p>(</span><span class=nx>wrapper</span><span class=p>,</span> <span class=nx>componentFactoryResolver</span><span class=p>,</span> <span class=nx>appRef</span><span class=p>,</span> <span class=nx>injector</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 存储此次添加的 dom出口
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>domPortalOutletCache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>wrapper</span><span class=p>,</span> <span class=nx>portalOutlet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 创建一个 填入出口 的 portalComponent 也就是去填占位符的ComponentPortal&lt;自定义组件实例&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>componentPortal</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ComponentPortal</span><span class=p>(</span><span class=nx>plantComponent</span><span class=p>.</span><span class=nx>component</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ComponentPortal&lt;自定义组件实例&gt; 填入出口中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>componentRef</span> <span class=o>=</span> <span class=nx>portalOutlet</span><span class=p>.</span><span class=nx>attachComponentPortal</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;(</span><span class=nx>componentPortal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果有初始化state
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>initialState</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 那么混入component的实例中去
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nb>Object</span><span class=p>.</span><span class=nx>assign</span><span class=p>(</span><span class=nx>componentRef</span><span class=p>.</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>initialState</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 传递一些引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>plantComponentRef</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>componentRef</span><span class=p>.</span><span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>plantComponentRef</span><span class=p>.</span><span class=nx>componentRef</span> <span class=o>=</span> <span class=nx>componentRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>plantComponentRef</span><span class=p>.</span><span class=nx>wrapperElement</span> <span class=o>=</span> <span class=nx>wrapper</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 注册卸载函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>plantComponentRef</span><span class=p>.</span><span class=nx>dispose</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 删除缓存的出口element
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>domPortalOutletCache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>wrapper</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 从dom中清除出口/占位符？
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>portalOutlet</span><span class=p>.</span><span class=nx>dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 返回 填上出口的 component引用 PlanetComponentRef 类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>plantComponentRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>registerComponentFactory</span><span class=p>(</span><span class=nx>componentOrComponents</span>: <span class=kt>PlanetComponent</span> <span class=o>|</span> <span class=nx>PlanetComponent</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取app名称
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngModuleRef</span><span class=p>.</span><span class=nx>instance</span><span class=p>.</span><span class=nx>appName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拿到当前应用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>getPlantAppRef</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>(</span><span class=nx>appRef</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>---</span> <span class=nx>registerComponentFactory</span>
</span></span><span class=line><span class=cl><span class=c1>// 传入匿名函数,函数两个参数:组件名称,config.返回一个PlanetComponentRef
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&gt;</span><span class=kr>export</span> <span class=kr>type</span> <span class=nx>PlantComponentFactory</span> <span class=o>=</span> <span class=p>&lt;</span><span class=nt>TData</span><span class=err>,</span> <span class=na>TComp</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>    <span class=nx>componentName</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>config</span>: <span class=kt>PlantComponentConfig</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>PlanetComponentRef</span><span class=p>&lt;</span><span class=nt>TComp</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=o>---</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 将 componentOrComponents转成数组
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>components</span> <span class=o>=</span> <span class=nx>coerceArray</span><span class=p>(</span><span class=nx>componentOrComponents</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 找到 与componentName名称一样的组件
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>component</span> <span class=o>=</span> <span class=nx>components</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>item</span> <span class=o>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>componentName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果存在
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=nx>component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 在变更检测范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>run</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// 附加组件，然后返回PlanetComponentRef匿名函数结束
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 此时，planet-application-ref的factory为注册组件的factory
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=c1>// 然后进行组件附加,传入component,模块引用，组件设置
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=kr>const</span> <span class=nx>componentRef</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>attachComponent</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;(</span><span class=nx>component</span><span class=p>,</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>appModuleRef</span><span class=p>,</span> <span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=nx>componentRef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`unregistered component </span><span class=si>${</span><span class=nx>componentName</span><span class=si>}</span><span class=sb> in app </span><span class=si>${</span><span class=nx>app</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 注册，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>register</span><span class=p>(</span><span class=nx>components</span>: <span class=kt>PlanetComponent</span> <span class=o>|</span> <span class=nx>PlanetComponent</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>registerComponentFactory</span><span class=p>(</span><span class=nx>components</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 加载,传入app名称,组件名称,配置项
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>load</span><span class=p>&lt;</span><span class=nt>TComp</span> <span class=err>=</span> <span class=na>unknown</span><span class=err>,</span> <span class=na>TData </span><span class=o>=</span> <span class=na>unknown</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>        <span class=nx>app</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>componentName</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span>: <span class=kt>PlantComponentConfig</span><span class=p>&lt;</span><span class=nt>TData</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>PlanetComponentRef</span><span class=err>&lt;</span><span class=na>TComp</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取应用的引用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getPlantAppRef</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=c1>//将源的发射延迟可观察到的时间间隔 由另一个 Observable 的发射确定。
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>delayWhen</span><span class=p>(</span><span class=nx>appRef</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>appRef</span><span class=p>.</span><span class=nx>getComponentFactory</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>of</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// Because register use &#39;setTimeout&#39;,so timer 20
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=nx>timer</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}),</span>
</span></span><span class=line><span class=cl>            <span class=nx>map</span><span class=p>(</span><span class=nx>appRef</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 拿到引用中的组件工厂
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>componentFactory</span> <span class=o>=</span> <span class=nx>appRef</span><span class=p>.</span><span class=nx>getComponentFactory</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>componentFactory</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 这里传入了componentName和config,从而调用了入口出口填补组件的函数`attachComponent`，比较巧妙
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>return</span> <span class=nx>componentFactory</span><span class=p>&lt;</span><span class=nt>TData</span><span class=err>,</span> <span class=na>TComp</span><span class=p>&gt;(</span><span class=nx>componentName</span><span class=p>,</span> <span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>app</span><span class=si>}</span><span class=sb>&#39;s component(</span><span class=si>${</span><span class=nx>componentName</span><span class=si>}</span><span class=sb>) is not registered`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}),</span>
</span></span><span class=line><span class=cl>            <span class=nx>finalize</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 变更检测
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>this</span><span class=p>.</span><span class=nx>applicationRef</span><span class=p>.</span><span class=nx>tick</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}),</span>
</span></span><span class=line><span class=cl>            <span class=nx>shareReplay</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>result</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=事件注册>事件注册<a hidden class=anchor aria-hidden=true href=#事件注册>#</a></h1><p>简单过一下事件注册</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// global-event-dispatcher.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>GlobalDispatcherEvent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>payload</span>: <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>CUSTOM_EVENT_NAME</span> <span class=o>=</span> <span class=s2>&#34;PLANET_GLOBAL_EVENT_DISPATCHER&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providedIn</span><span class=o>:</span> <span class=s2>&#34;root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>GlobalEventDispatcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ob
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>subject$</span>: <span class=kt>Subject</span><span class=p>&lt;</span><span class=nt>GlobalDispatcherEvent</span><span class=p>&gt;</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Subject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 是否加入了全局事件监听
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>hasAddGlobalEventListener</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 订阅总数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>subscriptionCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>globalEventListener</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span>: <span class=kt>CustomEvent</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subject$</span><span class=p>.</span><span class=nx>next</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 加入全局事件监听
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>addGlobalEventListener() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>hasAddGlobalEventListener</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=nx>CUSTOM_EVENT_NAME</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>globalEventListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 删除全局事件监听
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>removeGlobalEventListener() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>hasAddGlobalEventListener</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=nx>CUSTOM_EVENT_NAME</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>globalEventListener</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>ngZone</span>: <span class=kt>NgZone</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 发射数据,你可以通过 name进行数据的区分,发射的应该是主动方
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dispatch</span><span class=p>&lt;</span><span class=nt>TPayload</span><span class=p>&gt;(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>payload?</span>: <span class=kt>TPayload</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>dispatchEvent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过CUSTOM_EVENT_NAME 找到了 globalEventListener函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 然后将detail传入函数，所以现在subject中接收到值了
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>new</span> <span class=nx>CustomEvent</span><span class=p>(</span><span class=nx>CUSTOM_EVENT_NAME</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>detail</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>name</span>: <span class=kt>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>payload</span>: <span class=kt>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 注册事件 返回ob对象, 注册的应该是被动方
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>register</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span><span class=nx>eventName</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>Observable</span><span class=p>((</span><span class=nx>observer</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果没有全局事件监听，那么先添加
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>hasAddGlobalEventListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>addGlobalEventListener</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>subscriptionCount</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// subscription 用来去掉订阅用的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>subscription</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>subject$</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>filter</span><span class=p>((</span><span class=nx>event</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 过滤出eventName一致的payload
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=nx>event</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>eventName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}),</span>
</span></span><span class=line><span class=cl>          <span class=nx>map</span><span class=p>((</span><span class=nx>event</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 返回payload
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=nx>event</span><span class=p>.</span><span class=nx>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>subscribe</span><span class=p>((</span><span class=nx>payload</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 发射payload让订阅的地方得到值
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>this</span><span class=p>.</span><span class=nx>ngZone</span><span class=p>.</span><span class=nx>run</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>observer</span><span class=p>.</span><span class=nx>next</span><span class=p>(</span><span class=nx>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>subscriptionCount</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>subscription</span><span class=p>.</span><span class=nx>unsubscribe</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>subscriptionCount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>removeGlobalEventListener</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>getSubscriptionCount() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>subscriptionCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>看一个demo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 被动方,等待name=openADetail的event发射值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>globalEventDispatcher</span><span class=p>.</span><span class=nx>register</span><span class=p>(</span><span class=s1>&#39;openADetail&#39;</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>(</span><span class=nx>event</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>thyDialog</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>ADetailComponent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>//  name=openADetail 发射空值,此时上一个函数的 this.thyDialog.open(ADetailComponent);将被调用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>globalEventDispatcher</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>(</span><span class=s1>&#39;openADetail&#39;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=end>END<a hidden class=anchor aria-hidden=true href=#end>#</a></h1><p>结束,鄙人技术有限,有些地方不太准确(太不准确),不过按照这个思路将项目走一遍可以对 ngx-planet 有一个比较清晰的认识，有问题可<a href=mailto:harlancui@outlook.com>邮件</a>联系，或在 gitalk 中直接回复</p><blockquote><p>著名来源随意转载爬取 <a href=https://blog.eiyouhe.com/articles/2021/01/22/1611298349966.html>https://blog.eiyouhe.com/articles/2021/01/22/1611298349966.html</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://devcui.github.io/pokemon/tags/angular/>angular</a></li></ul><nav class=paginav><a class=prev href=https://devcui.github.io/pokemon/posts/angular/ngxplanet3/><span class=title>«</span><br><span>关于微前端实现原理与ngx-planet(三)</span></a>
<a class=next href=https://devcui.github.io/pokemon/posts/angular/ngxplanet4/><span class=title>»</span><br><span>关于微前端实现原理与ngx-planet(四)</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on twitter" href="https://twitter.com/intent/tweet/?text=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f&hashtags=angular"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f&title=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29&summary=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29&source=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f&title=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on whatsapp" href="https://api.whatsapp.com/send?text=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29%20-%20https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 关于微前端实现原理与ngx-planet(二) on telegram" href="https://telegram.me/share/url?text=%e5%85%b3%e4%ba%8e%e5%be%ae%e5%89%8d%e7%ab%af%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e4%b8%8engx-planet%28%e4%ba%8c%29&url=https%3a%2f%2fdevcui.github.io%2fpokemon%2fposts%2fangular%2fngxplanet2%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://devcui.github.io/pokemon/>神奇宝贝大师的旅行日记</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>